<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mandarin Pronunciation Learning Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 50%, #FFD700 100%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        /* Welcome Screen Styles */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 50%, #FFD700 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: gradientShift 6s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background: linear-gradient(135deg, #FF6B35 0%, #F7931E 50%, #FFD700 100%); }
            50% { background: linear-gradient(135deg, #FFD700 0%, #FF6B35 50%, #F7931E 100%); }
        }

        .welcome-container {
            text-align: center;
            color: white;
            max-width: 500px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: welcomeFloat 3s ease-in-out infinite;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes welcomeFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .binus-logo h1 {
            font-size: 2em;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .binus-logo h2 {
            font-size: 1.2em;
            margin-bottom: 20px;
            opacity: 0.9;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .welcome-character {
            position: relative;
            margin: 20px 0;
        }

        .mascot {
            font-size: 4em;
            animation: mascotBounce 2s ease-in-out infinite;
        }

        @keyframes mascotBounce {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(5deg); }
        }

        .speech-bubble {
            background: white;
            color: #333;
            padding: 12px 16px;
            border-radius: 15px;
            margin-top: 15px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: bubbleWiggle 3s ease-in-out infinite;
            font-size: 0.95em;
        }

        @keyframes bubbleWiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(1deg); }
            75% { transform: rotate(-1deg); }
        }

        .speech-bubble::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            border: 10px solid transparent;
            border-bottom-color: white;
        }

        .name-input-section {
            margin-top: 25px;
        }

        .name-input-section h3 {
            font-size: 1.4em;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .name-input-section p {
            font-size: 1em;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .name-input-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        #student-name-input {
            padding: 12px 16px;
            font-size: 1.1em;
            border: none;
            border-radius: 20px;
            width: 200px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        #student-name-input:focus {
            outline: none;
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .start-btn {
            padding: 12px 24px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 20px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .start-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .fun-facts {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            text-align: left;
        }

        .fun-facts p {
            margin: 8px 0;
            font-size: 0.9em;
        }

        /* Modern BINUS Header */
        .binus-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .school-info h1 {
            font-size: 1.8em;
            margin-bottom: 3px;
            background: linear-gradient(135deg, #FF6B35, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .school-info p {
            font-size: 0.9em;
            opacity: 0.9;
            margin: 0;
        }

        .student-info {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .student-avatar {
            font-size: 2em;
            animation: avatarWave 2s ease-in-out infinite;
        }

        @keyframes avatarWave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(15deg); }
            75% { transform: rotate(-10deg); }
        }

        .student-details {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .greeting {
            font-size: 1em;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 2px;
        }

        .student-name {
            font-size: 1.1em;
            font-weight: bold;
        }



        /* Footer Styles */
        .app-footer {
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 50px;
        }

        .footer-content {
            max-width: 800px;
            margin: 0 auto;
            color: white;
        }

        .footer-content p {
            margin: 0 0 10px 0;
            font-size: 0.9em;
            opacity: 0.8;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .footer-teacher-link {
            color: #FFD700;
            text-decoration: none;
            font-weight: bold;
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255, 215, 0, 0.1);
            transition: all 0.3s ease;
        }

        .footer-teacher-link:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateY(-1px);
        }

        /* Responsive Teacher Portal Button */
        @media (max-width: 768px) {
            .teacher-portal-btn {
                top: 15px;
                right: 15px;
                padding: 10px 16px;
                font-size: 0.85em;
            }
            
            .teacher-access-btn {
                padding: 12px 25px;
                font-size: 1em;
            }
            
            .footer-links {
                flex-direction: column;
                align-items: center;
            }
        }

        /* Responsive Design */
        @media (max-height: 700px) {
            .welcome-container {
                padding: 15px;
                max-height: 95vh;
            }
            
            .binus-logo h1 {
                font-size: 1.6em;
                margin-bottom: 5px;
            }
            
            .binus-logo h2 {
                font-size: 1em;
                margin-bottom: 15px;
            }
            
            .mascot {
                font-size: 3em;
            }
            
            .welcome-character {
                margin: 15px 0;
            }
            
            .name-input-section {
                margin-top: 15px;
            }
            
            .name-input-section h3 {
                font-size: 1.2em;
                margin-bottom: 8px;
            }
            
            .fun-facts {
                margin-top: 15px;
                padding: 12px;
            }
            
            .fun-facts p {
                margin: 6px 0;
                font-size: 0.85em;
            }
        }

        @media (max-width: 600px) {
            .binus-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .student-info {
                justify-content: center;
            }
            
            .level-indicator {
                position: relative;
                top: auto;
                right: auto;
                margin: 10px auto;
                display: block;
                text-align: center;
                max-width: 250px;
            }
            
            .name-input-container {
                flex-direction: column;
                gap: 15px;
            }
            
            #student-name-input {
                width: 220px;
            }
            
            .welcome-container {
                margin: 10px;
                max-width: calc(100% - 20px);
            }
        }

        @media (max-height: 600px) {
            body {
                padding: 10px;
            }
            
            .welcome-container {
                padding: 10px;
                border-radius: 15px;
            }
            
            .mascot {
                font-size: 2.5em;
            }
            
            .speech-bubble {
                padding: 8px 12px;
                font-size: 0.85em;
            }
            
            .level-indicator {
                top: 80px;
                padding: 8px 12px;
                font-size: 0.8em;
            }
            
            .fun-facts {
                display: none; /* Hide on very small screens */
            }
        }

        @media (max-width: 768px) and (min-width: 601px) {
            .level-indicator {
                top: 100px;
                right: 15px;
                font-size: 0.85em;
                padding: 10px 14px;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            animation: containerSlideIn 0.8s ease-out;
        }

        @keyframes containerSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(50px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .header {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            color: white;
            padding: 20px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }

        .mode-btn {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .mode-btn.teacher {
            background: #4CAF50;
            color: white;
        }

        .mode-btn.student {
            background: #2196F3;
            color: white;
        }

        .mode-btn.learning {
            background: #FF6B35;
            color: white;
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .mode-btn.active {
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transform: scale(1.05);
        }

        /* Student Class Selection Styles */
        .class-selection-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 30px;
            border-bottom: 3px solid #5a67d8;
        }

        .class-selection-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .class-selection-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .class-label {
            color: white;
            font-weight: bold;
            font-size: 1.1em;
        }

        #student-class-select {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            color: #333;
            min-width: 180px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .class-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .class-badge {
            background: #4CAF50;
            color: white;
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .class-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            margin: 20px 30px;
            padding: 20px;
            display: block;
        }

        .warning-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .warning-icon {
            font-size: 2em;
        }

        .warning-text h3 {
            color: #856404;
            margin: 0 0 5px 0;
        }

        .warning-text p {
            color: #856404;
            margin: 0;
            opacity: 0.8;
        }

        .content {
            padding: 30px;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group input:focus,
        .input-group textarea:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: red;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .audio-player {
            width: 100%;
            margin: 15px 0;
        }

        .lesson-list {
            list-style: none;
        }

        .lesson-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }

        .lesson-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .lesson-item.selected {
            background: #667eea;
            color: white;
        }

        /* Teacher Lessons Styling */
        .teacher-lessons-card {
            animation: priorityPulse 2s ease-in-out infinite;
        }

        @keyframes priorityPulse {
            0% { box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3); }
            50% { box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5); }
            100% { box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3); }
        }

        .priority-badge {
            animation: badgeBlink 1.5s ease-in-out infinite;
        }

        @keyframes badgeBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        #teacher-lessons-list .lesson-item {
            background: linear-gradient(135deg, #f8fff8 0%, #f0f8ff 100%);
            border-left: 4px solid #4caf50;
            position: relative;
        }

        #teacher-lessons-list .lesson-item::before {
            content: "üéØ";
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.2em;
        }

        #teacher-lessons-list .lesson-item:hover {
            background: linear-gradient(135deg, #e8f5e9 0%, #e3f2fd 100%);
            border-left: 4px solid #388e3c;
            transform: translateX(8px);
        }

        .practice-lessons-card {
            opacity: 0.9;
        }

        #practice-lessons-list .lesson-item {
            background: #f8f9fa;
            border-left: 4px solid #1976d2;
        }

        .score-display {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
            margin: 20px 0;
        }

        .score-number {
            font-size: 4em;
            font-weight: bold;
            margin: 20px 0;
        }

        .score-bar {
            width: 100%;
            height: 30px;
            background: rgba(255,255,255,0.3);
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 1s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .feedback-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .feedback-section h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .feedback-item {
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .waveform {
            width: 100%;
            height: 100px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .practice-history {
            margin-top: 20px;
        }

        .history-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-score {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        /* Gamification Styles */
        .level-indicator {
            position: fixed;
            top: 120px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 40px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            font-weight: bold;
            font-size: 0.9em;
            max-width: 200px;
        }

        .level-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            margin-left: 10px;
            font-size: 0.9em;
        }

        .xp-bar {
            width: 200px;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            margin: 8px 0;
            overflow: hidden;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 4px;
            transition: width 0.8s ease;
        }

        .achievement-notification {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.3);
            transform: translateX(-400px);
            transition: transform 0.5s ease;
            z-index: 1001;
            max-width: 350px;
        }

        .achievement-notification.show {
            transform: translateX(0);
        }

        .achievement-notification h3 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
        }

        .achievement-notification p {
            margin: 0;
            opacity: 0.9;
        }

        .ai-assistant {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 20px;
            max-width: 300px;
            transform: translateX(400px);
            transition: transform 0.5s ease;
            z-index: 1002;
        }

        .ai-assistant.show {
            transform: translateX(0);
        }

        .ai-assistant .ai-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .ai-assistant .ai-message {
            font-size: 0.9em;
            color: #333;
            line-height: 1.4;
        }

        .level-up-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(255, 215, 0, 0.5);
            text-align: center;
            z-index: 1003;
            animation: levelUpPulse 2s ease-in-out;
            display: none;
        }

        .level-up-animation.show {
            display: block;
        }

        @keyframes levelUpPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        .progress-ring {
            width: 60px;
            height: 60px;
            position: relative;
            display: inline-block;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            stroke-dasharray: 188.4;
            stroke-dashoffset: 188.4;
            transition: stroke-dashoffset 0.8s ease;
        }

        /* Learning Hub Styles */
        .learning-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .category-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .category-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .category-icon {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
        }

        .category-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .category-description {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 15px;
        }

        .lesson-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .lesson-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .lesson-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .lesson-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .lesson-icon {
            font-size: 2em;
            margin-right: 15px;
        }

        .lesson-info h3 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .lesson-info p {
            margin: 0;
            color: #666;
            font-size: 0.9em;
        }

        .lesson-content {
            margin-bottom: 15px;
        }

        .phonetic-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
        }

        .chinese-char {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .pinyin {
            font-size: 1.2em;
            color: #667eea;
            margin-bottom: 5px;
        }

        .english {
            font-size: 1em;
            color: #666;
        }

        .video-container {
            position: relative;
            width: 100%;
            height: 200px;
            background: #f0f0f0;
            border-radius: 8px;
            margin: 15px 0;
            overflow: hidden;
        }

        .video-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
        }

        .practice-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-play {
            background: #4CAF50;
            color: white;
        }

        .btn-practice {
            background: #2196F3;
            color: white;
        }

        .btn-small:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .difficulty-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }

        .difficulty-beginner {
            background: #4CAF50;
            color: white;
        }

        .difficulty-intermediate {
            background: #FF9800;
            color: white;
        }

        .difficulty-advanced {
            background: #f44336;
            color: white;
        }

        .progress-indicator {
            background: #f0f0f0;
            height: 4px;
            border-radius: 2px;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 2px;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body>
    <!-- Gamification Elements -->
    <div class="level-indicator" id="level-indicator">
        üéØ Level <span id="current-level">1</span>
        <span class="level-badge" id="level-badge">Beginner</span>
        <div class="xp-bar">
            <div class="xp-fill" id="xp-fill" style="width: 0%"></div>
        </div>
        <small id="xp-text">0 / 100 XP</small>
    </div>

    <div class="achievement-notification" id="achievement-notification">
        <h3 id="achievement-title">üéâ Achievement Unlocked!</h3>
        <p id="achievement-text">You've reached a new milestone!</p>
    </div>

    <div class="ai-assistant" id="ai-assistant">
        <div class="ai-avatar">ü§ñ</div>
        <div class="ai-message" id="ai-message">
            Welcome! I'll help track your progress and give you tips as you practice.
        </div>
    </div>

    <div class="level-up-animation" id="level-up-animation">
        <h2>üéä LEVEL UP! üéä</h2>
        <div class="progress-ring">
            <svg width="60" height="60">
                <circle cx="30" cy="30" r="30" stroke="#FFD700" stroke-width="4" fill="transparent" class="progress-ring-circle" />
            </svg>
        </div>
        <p>You've reached Level <span id="level-up-number">2</span>!</p>
        <h3 id="level-up-title">Novice Speaker</h3>
    </div>

    <!-- Welcome Screen -->
    <div class="welcome-screen" id="welcome-screen">
        <div class="welcome-container">
            <div class="binus-logo">
                <h1>üéì BINUS School Simprug</h1>
                <h2>ü§ñ AI-Powered Mandarin Learning Hub</h2>
            </div>
            
            <div class="welcome-character">
                <div class="mascot">üêº</div>
                <div class="speech-bubble">
                    <p>‰Ω†Â•Ω! Hello there, future Mandarin master! ÔøΩ</p>
                </div>
            </div>
            
            <div class="name-input-section" id="name-step">
                <h3>Let's get started with your Mandarin journey!</h3>
                <p>Please enter your <strong>real first name</strong> to personalize your learning experience:</p>
                
                <div class="name-input-container">
                    <input type="text" id="student-name-input" placeholder="Enter your first name..." maxlength="20">
                    <button class="start-btn" onclick="proceedToClassSelection()">
                        <span>Next: Select Class üìö</span>
                    </button>
                </div>
                
                <div class="fun-facts">
                    <p>üí° <strong>Fun Fact:</strong> Over 918 million people speak Mandarin worldwide!</p>
                    <p>üéØ <strong>Today's Goal:</strong> Master pronunciation with AI-powered feedback</p>
                </div>
            </div>

            <div class="class-selection-section" id="class-step" style="display: none;">
                <h3>Welcome <span id="welcome-name">Student</span>! üéâ</h3>
                <p>Now, please select your <strong>grade and class</strong> to see lessons assigned by your teacher:</p>
                
                <div class="class-selection-container">
                    <select id="welcome-class-select" style="padding: 15px; font-size: 1.1em; border-radius: 8px; border: 2px solid #fff; margin-bottom: 20px; width: 100%;">
                        <option value="">Choose your class...</option>
                        <option value="Grade1A">Grade 1A</option>
                        <option value="Grade1B">Grade 1B</option>
                        <option value="Grade2A">Grade 2A</option>
                        <option value="Grade2B">Grade 2B</option>
                        <option value="Grade3A">Grade 3A</option>
                        <option value="Grade3B">Grade 3B</option>
                        <option value="Grade3C">Grade 3C</option>
                        <option value="Grade4A">Grade 4A</option>
                        <option value="Grade4B">Grade 4B</option>
                        <option value="Grade4C">Grade 4C</option>
                        <option value="Grade5A">Grade 5A</option>
                        <option value="Grade5B">Grade 5B</option>
                    </select>
                    
                    <button class="start-btn" onclick="startLearning()">
                        <span>üöÄ Enter Class & Start Learning</span>
                    </button>
                </div>
                
                <div class="class-info">
                    <p>‚ö†Ô∏è <strong>Important:</strong> You must select the exact same grade your teacher uses for assignments!</p>
                    <p>üìö <strong>What happens next:</strong> You'll see lessons assigned specifically to your class</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="main-container" style="display: none;">

        
        <div class="header">
            <div class="binus-header">
                <div class="school-info">
                    <h1>üéì BINUS School Simprug</h1>
                    <p>AI-Powered Mandarin Learning Hub</p>
                </div>
                <div class="student-info">
                    <div class="student-avatar">üëã</div>
                    <div class="student-details">
                        <span class="greeting" id="header-greeting">Hello BINUSIAN!</span>
                        <span class="student-name" id="header-student-name">Student</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Class Selection -->
        <div class="class-selection-bar" id="student-class-selection">
            <div class="class-selection-content">
                <div class="class-selection-left">
                    <span class="class-label">üìö Select Your Class:</span>
                    <select id="student-class-select" onchange="changeStudentClass()">
                        <option value="">Choose your class...</option>
                        <option value="Grade1A">Grade 1A</option>
                        <option value="Grade1B">Grade 1B</option>
                        <option value="Grade2A">Grade 2A</option>
                        <option value="Grade2B">Grade 2B</option>
                        <option value="Grade3A">Grade 3A</option>
                        <option value="Grade3B">Grade 3B</option>
                        <option value="Grade3C">Grade 3C</option>
                        <option value="Grade4A">Grade 4A</option>
                        <option value="Grade4B">Grade 4B</option>
                        <option value="Grade4C">Grade 4C</option>
                        <option value="Grade5A">Grade 5A</option>
                        <option value="Grade5B">Grade 5B</option>
                    </select>
                </div>
                <div class="class-info" id="student-class-info" style="display: none;">
                    <span class="class-badge" id="student-class-badge">No Class</span>
                </div>
            </div>
        </div>

        <!-- Class Selection Warning -->
        <div class="class-warning" id="student-class-warning">
            <div class="warning-content">
                <div class="warning-icon">‚ö†Ô∏è</div>
                <div class="warning-text">
                    <h3>Please Select Your Grade & Class</h3>
                    <p>Choose your exact grade and class from the dropdown above to see lessons assigned by your teacher.<br><strong>Note:</strong> You must select the same grade your teacher used when creating lessons.</p>
                </div>
            </div>
        </div>

        <div class="mode-selector">
            <button class="mode-btn student active" onclick="switchMode('student')">
                üë®‚ÄçÔøΩ Student Mode
            </button>
            <button class="mode-btn learning" onclick="switchMode('learning')" style="background: #FF6B35;">
                ÔøΩ Learning Hub
            </button>

            <button class="mode-btn" onclick="resetProfile()" style="background: #6c757d; font-size: 0.9em;">
                ÔøΩ Reset Profile
            </button>
        </div>

        <div class="content">
            <!-- Student Section -->
            <div id="student-section" class="section active">
                <!-- Teacher Assigned Lessons Section -->
                <div class="card teacher-lessons-card" style="background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%); border-left: 5px solid #4caf50; margin-bottom: 25px;">
                    <h2 style="color: #2e7d32; display: flex; align-items: center; gap: 10px;">
                        ÔøΩ Lessons Assigned by Your Teacher
                        <span class="priority-badge" style="background: #4caf50; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: bold;">PRIORITY</span>
                    </h2>
                    <p style="color: #2e7d32; margin-bottom: 15px; font-style: italic;">Complete these lessons first - they are specifically assigned to your class!</p>
                    <ul class="lesson-list" id="teacher-lessons-list"></ul>
                </div>

                <!-- Practice Lessons Section -->
                <div class="card practice-lessons-card">
                    <h2 style="color: #1976d2;">üìö Additional Practice Lessons</h2>
                    <p style="color: #666; margin-bottom: 15px;">Extra lessons for additional practice when you're done with your assigned work.</p>
                    <ul class="lesson-list" id="practice-lessons-list"></ul>
                </div>

                <div id="practice-area" style="display: none;">
                    <div class="card">
                        <h2 id="current-lesson-title">Practice</h2>
                        <p id="current-lesson-text" style="font-size: 1.5em; margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 12px; border-left: 5px solid #2196F3;"></p>
                        
                        <div id="student-instructions-section" style="display: none; margin-bottom: 20px;">
                            <h3 style="color: #2196F3; margin-bottom: 10px;">üìã Instructions:</h3>
                            <p id="student-instructions-text" style="background: #fff3e0; padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800; font-style: italic;"></p>
                        </div>

                        <div id="master-audio-section" style="margin-bottom: 30px;">
                            <h3 style="color: #4caf50; margin-bottom: 15px;">üîä Listen to Master Recording:</h3>
                            <div id="master-audio-player" style="background: #f0f8f0; padding: 20px; border-radius: 12px; border-left: 5px solid #4caf50;">
                                <p style="color: #666; text-align: center;">Select a lesson to hear the master recording</p>
                            </div>
                        </div>

                        <h3 style="margin-top: 30px;">üé§ Record Your Pronunciation:</h3>
                        <p style="color: #666; margin-bottom: 20px;">Click record and speak the text above clearly. Our AI will analyze your pronunciation!</p>
                        <button class="btn btn-danger" id="student-record-btn" onclick="startStudentRecording()">
                            üé§ Start Recording
                        </button>
                        <button class="btn btn-primary" id="student-stop-btn" onclick="stopStudentRecording()" disabled>
                            ‚èπÔ∏è Stop Recording
                        </button>
                        <div id="student-audio-preview"></div>

                        <button class="btn btn-success" onclick="analyzeRecording()" id="analyze-btn" disabled>
                            üîç Analyze My Pronunciation
                        </button>
                    </div>

                    <div id="results-area" style="display: none;">
                        <div class="score-display">
                            <h2>Your Score</h2>
                            <div class="score-number" id="score-number">--</div>
                            <div class="score-bar">
                                <div class="score-fill" id="score-fill" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="feedback-section">
                            <h3>ü§ñ AI Feedback & Analysis</h3>
                            <div id="ai-feedback"></div>
                        </div>

                        <div class="feedback-section">
                            <h3>üìä Detailed Metrics</h3>
                            <div id="detailed-metrics"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 id="progress-title">üìà Your Progress</h2>
                    <div class="dashboard" id="student-dashboard">
                        <div class="stat-card">
                            <h3 id="total-attempts">0</h3>
                            <p>Total Attempts</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="avg-score">0</h3>
                            <p>Average Score</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="best-score">0</h3>
                            <p>Best Score</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="current-level-dash">1</h3>
                            <p>Current Level</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="total-xp">0</h3>
                            <p>Total XP</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="achievements-count">0</h3>
                            <p>Achievements</p>
                        </div>
                    </div>

                    <div class="practice-history">
                        <h3>Recent Practice Sessions</h3>
                        <div id="history-list"></div>
                    </div>
                </div>
            </div>

            <!-- Learning Hub Section -->
            <div id="learning-section" class="section">
                <div class="card">
                    <h2>üìö Learning Hub - Master Mandarin Fundamentals</h2>
                    <p>Choose a category to start your learning journey with interactive lessons, videos, and practice exercises.</p>
                    
                    <div class="learning-categories" id="learning-categories">
                        <div class="category-card" onclick="selectCategory('vowels')">
                            <span class="category-icon">üó£Ô∏è</span>
                            <div class="category-title">Vowels (ÈüµÊØç)</div>
                            <div class="category-description">Master the 6 basic vowels and compound vowels</div>
                            <div class="progress-indicator">
                                <div class="progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="category-card" onclick="selectCategory('consonants')">
                            <span class="category-icon">üí¨</span>
                            <div class="category-title">Consonants (Â£∞ÊØç)</div>
                            <div class="category-description">Learn 21 initial consonant sounds</div>
                            <div class="progress-indicator">
                                <div class="progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="category-card" onclick="selectCategory('tones')">
                            <span class="category-icon">üéµ</span>
                            <div class="category-title">Tones (Â£∞Ë∞É)</div>
                            <div class="category-description">Master the 4 Mandarin tones + neutral tone</div>
                            <div class="progress-indicator">
                                <div class="progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="category-card" onclick="selectCategory('pinyin')">
                            <span class="category-icon">üìù</span>
                            <div class="category-title">Pinyin System</div>
                            <div class="category-description">Complete pinyin spelling and pronunciation</div>
                            <div class="progress-indicator">
                                <div class="progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="category-card" onclick="selectCategory('basics')">
                            <span class="category-icon">üåü</span>
                            <div class="category-title">Basic Words</div>
                            <div class="category-description">Essential vocabulary for beginners</div>
                            <div class="progress-indicator">
                                <div class="progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="category-card" onclick="selectCategory('sentences')">
                            <span class="category-icon">üí≠</span>
                            <div class="category-title">Common Phrases</div>
                            <div class="category-description">Everyday expressions and greetings</div>
                            <div class="progress-indicator">
                                <div class="progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" id="lesson-content" style="display: none;">
                    <h2 id="category-title">Select a Category</h2>
                    <div class="lesson-grid" id="lesson-grid">
                        <!-- Lessons will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="app-footer">
        <div class="footer-content">
            <p>¬© 2025 BINUS School Simprug - AI-Powered Mandarin Learning</p>
            <div class="footer-links">
                <a href="/" class="footer-teacher-link">
                    ÔøΩ Back to Home
                </a>
            </div>
        </div>
    </footer>

    <!-- Supabase is optional for students - only load if config is available -->
    <script>
        // Check if we need Supabase for this student page
        const needsSupabase = false; // Students don't need authentication
        
        if (needsSupabase) {
            // Only load Supabase if needed (for future features)
            const supabaseScript = document.createElement('script');
            supabaseScript.src = 'https://unpkg.com/@supabase/supabase-js@2';
            document.head.appendChild(supabaseScript);
            
            supabaseScript.onload = () => {
                const configScript = document.createElement('script');
                configScript.src = 'supabase-config.js';
                configScript.onerror = () => {
                    console.log('Supabase config not available - using offline mode');
                };
                document.head.appendChild(configScript);
            };
        }
    </script>
    <script>
        // Global variables
        let mediaRecorder;
        let audioChunks = [];
        let currentMode = 'student'; // Start with student mode
        let lessons = JSON.parse(localStorage.getItem('mandarinLessons') || '[]');
        let practiceHistory = JSON.parse(localStorage.getItem('practiceHistory') || '[]');
        let currentLesson = null;

        // Initialize with default lessons if none exist
        if (lessons.length === 0) {
            lessons = [
                {
                    id: 'demo1',
                    title: 'Basic Greeting - Hello',
                    text: '‰Ω†Â•Ω (N«ê h«éo)',
                    category: 'greetings',
                    difficulty: 'beginner',
                    notes: 'The most common greeting in Mandarin',
                    isPublic: true
                },
                {
                    id: 'demo2', 
                    title: 'Thank You',
                    text: 'Ë∞¢Ë∞¢ (Xi√® xi√®)',
                    category: 'greetings',
                    difficulty: 'beginner',
                    notes: 'Essential polite expression',
                    isPublic: true
                },
                {
                    id: 'demo3',
                    title: 'Numbers 1-3',
                    text: '‰∏Ä„ÄÅ‰∫å„ÄÅ‰∏â (Yƒ´, √®r, sƒÅn)',
                    category: 'numbers',
                    difficulty: 'beginner', 
                    notes: 'Basic counting practice',
                    isPublic: true
                },
                {
                    id: 'demo4',
                    title: 'Family - Mother',
                    text: 'Â¶àÂ¶à (MƒÅ ma)',
                    category: 'family',
                    difficulty: 'beginner',
                    notes: 'Family member vocabulary',
                    isPublic: true
                },
                {
                    id: 'demo5',
                    title: 'Colors - Red',
                    text: 'Á∫¢Ëâ≤ (H√≥ng s√®)',
                    category: 'colors',
                    difficulty: 'intermediate',
                    notes: 'Color vocabulary practice',
                    isPublic: true
                }
            ];
            localStorage.setItem('mandarinLessons', JSON.stringify(lessons));
        }
        let masterAudioBlob = null;
        let studentAudioBlob = null;
        let studentName = localStorage.getItem('studentName') || '';
        let currentStudent = null;
        let currentGreeting = '';
        let currentStudentClass = localStorage.getItem('selectedStudentClass') || null;

        // Gamification variables
        let playerStats = JSON.parse(localStorage.getItem('playerStats') || JSON.stringify({
            level: 1,
            xp: 0,
            totalPractice: 0,
            streak: 0,
            achievements: [],
            lastPracticeDate: null
        }));

        // Level system configuration
        const LEVEL_THRESHOLDS = [0, 100, 250, 450, 700, 1000, 1400, 1900, 2500, 3200, 4000];
        const LEVEL_TITLES = [
            'Newbie', 'Beginner', 'Novice', 'Learner', 'Student', 'Practitioner', 
            'Intermediate', 'Advanced', 'Expert', 'Master', 'Grandmaster'
        ];

        // Achievement definitions
        const ACHIEVEMENTS = {
            first_practice: { title: "First Steps", description: "Completed your first practice session!", xp: 20 },
            level_5: { title: "Rising Star", description: "Reached Level 5!", xp: 50 },
            level_10: { title: "Pronunciation Master", description: "Reached Level 10!", xp: 100 },
            perfect_score: { title: "Perfection!", description: "Achieved a perfect score!", xp: 75 },
            high_scorer: { title: "High Achiever", description: "Scored above 90%!", xp: 30 },
            consistent: { title: "Consistent Learner", description: "Practiced 5 times!", xp: 40 },
            streak_3: { title: "On Fire!", description: "3-day practice streak!", xp: 25 },
            tone_master: { title: "Tone Master", description: "Excellent tone accuracy!", xp: 35 }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if both student name and class exist
            if (studentName && currentStudentClass) {
                // Skip welcome screen completely
                document.getElementById('welcome-screen').style.display = 'none';
                document.getElementById('main-container').style.display = 'block';
                
                // Update header immediately for returning students
                updatePersonalizedHeader();
                
                initializeApp();
            } else if (studentName && !currentStudentClass) {
                // Show class selection step
                document.getElementById('welcome-screen').style.display = 'flex';
                document.getElementById('main-container').style.display = 'none';
                document.getElementById('name-step').style.display = 'none';
                document.getElementById('class-step').style.display = 'block';
                document.getElementById('welcome-name').textContent = studentName;
                
                // Update header even when showing class selection
                document.getElementById('header-greeting').textContent = `Hello ${studentName}! üåü`;
                document.getElementById('header-student-name').textContent = `BINUSIAN ‚Ä¢ ${studentName}`;
            } else {
                // Show name input step
                document.getElementById('welcome-screen').style.display = 'flex';
                document.getElementById('main-container').style.display = 'none';
                document.getElementById('name-step').style.display = 'block';
                document.getElementById('class-step').style.display = 'none';
            }
            
            // Add enter key support for name input
            document.getElementById('student-name-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    proceedToClassSelection();
                }
            });
        });

        function initializeApp() {
            initializeStudentClass();
            loadLessons();
            updateDashboard();
            initializeGamification();
            updateLevelDisplay();
            showPersonalizedWelcome();
            initializeSpeech();
            updatePersonalizedHeader();
        }



        function proceedToClassSelection() {
            const nameInput = document.getElementById('student-name-input');
            const name = nameInput.value.trim();
            
            if (!name) {
                // Shake animation for empty input
                nameInput.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    nameInput.style.animation = '';
                }, 500);
                return;
            }
            
            // Validate name (only letters and spaces)
            if (!/^[a-zA-Z\s]+$/.test(name)) {
                alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂêçÂ≠ó! Please enter a valid name (letters only)! üòä');
                return;
            }
            
            // Store student name
            studentName = name;
            localStorage.setItem('studentName', studentName);
            
            // Update header immediately when name is entered
            document.getElementById('header-greeting').textContent = `Hello ${studentName}! üåü`;
            document.getElementById('header-student-name').textContent = `BINUSIAN ‚Ä¢ ${studentName}`;
            
            // Show class selection step
            document.getElementById('name-step').style.display = 'none';
            document.getElementById('class-step').style.display = 'block';
            document.getElementById('welcome-name').textContent = name;
        }

        function startLearning() {
            const classSelect = document.getElementById('welcome-class-select');
            const selectedClass = classSelect.value;
            
            if (!selectedClass) {
                // Shake animation for empty selection
                classSelect.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    classSelect.style.animation = '';
                }, 500);
                alert('Please select your class first! üìö');
                return;
            }
            
            // Store class selection
            currentStudentClass = selectedClass;
            localStorage.setItem('selectedStudentClass', selectedClass);
            
            // Initialize student (without class code)
            initializeStudent(name);
            
            // Hide welcome screen with animation
            const welcomeScreen = document.getElementById('welcome-screen');
            welcomeScreen.style.animation = 'fadeOut 0.8s ease-in';
            
            setTimeout(() => {
                welcomeScreen.style.display = 'none';
                document.getElementById('main-container').style.display = 'block';
                
                // Hide class selection bar since student has already chosen their class
                document.getElementById('student-class-selection').style.display = 'none';
                
                initializeApp();
            }, 800);
        }

        function updatePersonalizedHeader() {
            // Ensure we have a student name
            if (!studentName || studentName.trim() === '') {
                studentName = localStorage.getItem('studentName') || 'Student';
            }
            
            const greetings = [
                `‰Ω†Â•Ω ${studentName}! (n«ê h«éo)`,
                `Hello ${studentName}! üåü`,
                `Ready to learn, ${studentName}?`,
                `Welcome back, ${studentName}! üéØ`,
                `Let's practice, ${studentName}! üí™`,
                `Great to see you, ${studentName}! üöÄ`
            ];
            
            const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
            currentGreeting = randomGreeting;
            
            document.getElementById('header-greeting').textContent = randomGreeting;
            document.getElementById('header-student-name').textContent = `BINUSIAN ‚Ä¢ ${studentName}`;
            
            // Update progress title with student name
            document.getElementById('progress-title').textContent = `üìà ${studentName}'s Progress`;
        }



        function showPersonalizedWelcome() {
            const welcomeMessages = [
                `üéâ ‰Ω†Â•Ω ${studentName}! Ready to be a Mandarin superstar? Âä†Ê≤π!`,
                `üåü Hey ${studentName}! ÂæàÂ•Ω! Your pronunciation is getting stronger! üí™`,
                `üöÄ Âìá! ${studentName} is back! Time to sound like a native speaker! Ê£í!`,
                `ÔøΩ Nihao ${studentName}! Let's make some tones so smooth they'll say Â§™Â•Ω‰∫Ü!`,
                `üéØ ${studentName}, you're ÈùûÂ∏∏Ê£í! Keep being awesome! ÁªßÁª≠!`,
                `‚ú® ÂáÜÂ§áÂ•Ω‰∫ÜÂêó ${studentName}? Let's make magic happen! ‚ú®`,
                `ü§ñ Beep boop! ${studentName} detected! Mandarin powers: ACTIVATING! ÂìàÂìà!`
            ];
            
            const randomMessage = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
            
            setTimeout(() => {
                showAIMessage(randomMessage);
            }, 1000);
        }

        // Add CSS for shake animation
        const shakeKeyframes = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-10px); }
                75% { transform: translateX(10px); }
            }
            @keyframes fadeOut {
                from { opacity: 1; transform: scale(1); }
                to { opacity: 0; transform: scale(0.9); }
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.textContent = shakeKeyframes;
        document.head.appendChild(styleSheet);

        function resetProfile() {
            if (confirm(`Hey ${studentName}! Are you sure you want to reset your profile? This will clear your name and progress.`)) {
                localStorage.removeItem('studentName');
                localStorage.removeItem('playerStats');
                localStorage.removeItem('practiceHistory');
                
                showAIMessage('Profile reset! Please refresh the page to start over. üëã');
                
                setTimeout(() => {
                    location.reload();
                }, 2000);
            }
        }

        // Student Class Management Functions
        function initializeStudentClass() {
            const classSelect = document.getElementById('student-class-select');
            const classInfo = document.getElementById('student-class-info');
            const classBadge = document.getElementById('student-class-badge');
            const classWarning = document.getElementById('student-class-warning');
            
            if (currentStudentClass) {
                classSelect.value = currentStudentClass;
                classInfo.style.display = 'block';
                classBadge.textContent = currentStudentClass;
                classWarning.style.display = 'none';
                
                // Load lessons for the saved class
                loadLessons();
                
                // Show welcome message for saved class
                setTimeout(() => {
                    showAIMessage(`Welcome back to ${currentStudentClass}! üéì Ready to practice your pronunciation?`);
                }, 2000);
            } else {
                classInfo.style.display = 'none';
                classWarning.style.display = 'block';
            }
        }

        function changeStudentClass() {
            const classSelect = document.getElementById('student-class-select');
            const selectedClass = classSelect.value;
            const classInfo = document.getElementById('student-class-info');
            const classBadge = document.getElementById('student-class-badge');
            const classWarning = document.getElementById('student-class-warning');
            
            if (selectedClass) {
                currentStudentClass = selectedClass;
                localStorage.setItem('selectedStudentClass', selectedClass);
                classInfo.style.display = 'block';
                classBadge.textContent = selectedClass;
                classWarning.style.display = 'none';
                
                // Reload lessons filtered by class
                loadLessons();
                showAIMessage(`Welcome to ${selectedClass}! üìö Loading lessons assigned by your teacher...`);
            } else {
                currentStudentClass = null;
                localStorage.removeItem('selectedStudentClass');
                classInfo.style.display = 'none';
                classWarning.style.display = 'block';
                
                // Clear lessons when no class selected
                document.getElementById('teacher-lessons-list').innerHTML = '<p style="text-align: center; color: #666;">Please select your class to see lessons.</p>';
                document.getElementById('practice-lessons-list').innerHTML = '<p style="text-align: center; color: #666;">Please select your class to see lessons.</p>';
            }
        }

        // Gamification Functions
        function initializeGamification() {
            // Update level display
            updateLevelDisplay();
            
            // Show AI assistant after 3 seconds
            setTimeout(() => {
                showAIMessage("Ready to practice? Let's improve your Mandarin pronunciation together! üöÄ");
            }, 3000);
        }

        function updateLevelDisplay() {
            const currentLevel = getCurrentLevel();
            const currentLevelIndex = currentLevel - 1;
            const nextLevelXP = LEVEL_THRESHOLDS[currentLevel] || LEVEL_THRESHOLDS[LEVEL_THRESHOLDS.length - 1];
            const currentLevelXP = LEVEL_THRESHOLDS[currentLevelIndex];
            const xpInCurrentLevel = playerStats.xp - currentLevelXP;
            const xpNeededForLevel = nextLevelXP - currentLevelXP;
            const xpProgress = (xpInCurrentLevel / xpNeededForLevel) * 100;

            document.getElementById('current-level').textContent = currentLevel;
            document.getElementById('level-badge').textContent = LEVEL_TITLES[currentLevelIndex] || 'Grandmaster';
            document.getElementById('xp-fill').style.width = Math.min(100, xpProgress) + '%';
            document.getElementById('xp-text').textContent = `${playerStats.xp} / ${nextLevelXP} XP`;
        }

        function getCurrentLevel() {
            for (let i = LEVEL_THRESHOLDS.length - 1; i >= 0; i--) {
                if (playerStats.xp >= LEVEL_THRESHOLDS[i]) {
                    return i + 1;
                }
            }
            return 1;
        }

        function awardXP(amount, reason = '') {
            const oldLevel = getCurrentLevel();
            playerStats.xp += amount;
            playerStats.totalPractice++;
            
            // Save stats
            localStorage.setItem('playerStats', JSON.stringify(playerStats));
            
            const newLevel = getCurrentLevel();
            
            // Update display
            updateLevelDisplay();
            
            // Check for level up
            if (newLevel > oldLevel) {
                showLevelUpAnimation(newLevel);
                checkAchievements('level_' + newLevel);
            }
            
            // Show XP notification
            if (amount > 0) {
                showAIMessage(`+${amount} XP earned! ${reason} üåü`);
            }
        }

        function showLevelUpAnimation(newLevel) {
            const levelUpDiv = document.getElementById('level-up-animation');
            const levelNumber = document.getElementById('level-up-number');
            const levelTitle = document.getElementById('level-up-title');
            
            levelNumber.textContent = newLevel;
            levelTitle.textContent = LEVEL_TITLES[newLevel - 1] || 'Grandmaster';
            
            levelUpDiv.classList.add('show');
            
            setTimeout(() => {
                levelUpDiv.classList.remove('show');
            }, 3000);
        }

        function checkAchievements(type, score = 0) {
            const newAchievements = [];
            
            // Check various achievement conditions
            switch(type) {
                case 'first_practice':
                    if (!playerStats.achievements.includes('first_practice')) {
                        newAchievements.push('first_practice');
                    }
                    break;
                    
                case 'perfect_score':
                    if (score >= 98 && !playerStats.achievements.includes('perfect_score')) {
                        newAchievements.push('perfect_score');
                    }
                    break;
                    
                case 'high_scorer':
                    if (score >= 90 && !playerStats.achievements.includes('high_scorer')) {
                        newAchievements.push('high_scorer');
                    }
                    break;
                    
                case 'consistent':
                    if (playerStats.totalPractice >= 5 && !playerStats.achievements.includes('consistent')) {
                        newAchievements.push('consistent');
                    }
                    break;
                    
                case 'tone_master':
                    if (score >= 85 && !playerStats.achievements.includes('tone_master')) {
                        newAchievements.push('tone_master');
                    }
                    break;
            }
            
            // Check level achievements
            if (type.startsWith('level_')) {
                const level = parseInt(type.split('_')[1]);
                if ((level === 5 || level === 10) && !playerStats.achievements.includes(type)) {
                    newAchievements.push(type);
                }
            }
            
            // Award achievements
            newAchievements.forEach(achievement => {
                playerStats.achievements.push(achievement);
                showAchievement(achievement);
                awardXP(ACHIEVEMENTS[achievement].xp, ACHIEVEMENTS[achievement].description);
            });
            
            // Save updated achievements
            localStorage.setItem('playerStats', JSON.stringify(playerStats));
        }

        function showAchievement(achievementKey) {
            const achievement = ACHIEVEMENTS[achievementKey];
            const notificationDiv = document.getElementById('achievement-notification');
            const titleElement = document.getElementById('achievement-title');
            const textElement = document.getElementById('achievement-text');
            
            titleElement.textContent = `üèÜ ${achievement.title}`;
            textElement.textContent = achievement.description;
            
            notificationDiv.classList.add('show');
            
            setTimeout(() => {
                notificationDiv.classList.remove('show');
            }, 4000);
        }

        function showAIMessage(message) {
            const aiAssistant = document.getElementById('ai-assistant');
            const messageElement = document.getElementById('ai-message');
            
            // Personalize the message if student name is available
            let personalizedMessage = message;
            if (studentName && !message.includes(studentName)) {
                const personalPrefixes = [
                    `${studentName}, `,
                    `Hey ${studentName}! `,
                    `Great job ${studentName}! `,
                    `${studentName}, you're doing great! `,
                    `Nice work ${studentName}! `
                ];
                
                if (Math.random() > 0.3) { // 70% chance to personalize
                    const randomPrefix = personalPrefixes[Math.floor(Math.random() * personalPrefixes.length)];
                    personalizedMessage = randomPrefix + message;
                }
            }
            
            messageElement.textContent = personalizedMessage;
            aiAssistant.classList.add('show');
            
            setTimeout(() => {
                aiAssistant.classList.remove('show');
            }, 5000);
        }

        function showWelcomeMessage() {
            const messages = [
                "Ê¨¢ËøéÂõûÊù•! Ready to sound ÂæàÊ£í? Let's go! üéØ",
                "Your ÂèëÈü≥ journey continues! Âä†Ê≤πÂä†Ê≤π! üöÄ", 
                "Time to master those tones! ÊàëÁõ∏‰ø°‰Ω†! You got this! üí™",
                "Every practice = closer to being ÂéâÂÆ≥! Keep going! ‚ú®",
                "Mandarin mode: ON! ÂáÜÂ§áÂ•Ω‰∫ÜÂêó? Let's make noise! üî•"
            ];
            
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            
            setTimeout(() => {
                showAIMessage(randomMessage);
            }, 1000);
        }

        function generateRandomStudentName() {
            const names = [
                "Yu Min", "Li Wei", "Zhang Mei", "Wang Jun", "Chen Xiao", 
                "Liu Yang", "Zhao Lin", "Wu Hua", "Zhou Lei", "Xu Ning",
                "Sun Yue", "Ma Qing", "Zhu Feng", "He Jing", "Gao Yu"
            ];
            return names[Math.floor(Math.random() * names.length)];
        }

        // Learning Hub Data
        const LEARNING_CONTENT = {
            vowels: {
                title: "üó£Ô∏è Vowels (ÈüµÊØç)",
                description: "Master Mandarin vowel sounds",
                lessons: [
                    {
                        id: 'vowel_a',
                        title: 'Vowel A (Âïä)',
                        difficulty: 'beginner',
                        content: { chinese: 'Âïä', pinyin: 'ƒÅ √° «é √†', english: 'ah (exclamation)' },
                        description: 'The most basic vowel sound in Mandarin',
                        videoId: 'kYHSH-pWjUw', // Mandarin vowels tutorial
                        tips: 'Open your mouth wide, tongue flat and low'
                    },
                    {
                        id: 'vowel_o',
                        title: 'Vowel O (Âì¶)',
                        difficulty: 'beginner',
                        content: { chinese: 'Âì¶', pinyin: '≈ç √≥ «í √≤', english: 'oh' },
                        description: 'Round vowel sound, lips rounded',
                        videoId: 'kYHSH-pWjUw',
                        tips: 'Round your lips, tongue pulled back'
                    },
                    {
                        id: 'vowel_e',
                        title: 'Vowel E (ÂëÉ)',
                        difficulty: 'beginner',
                        content: { chinese: 'ÂëÉ', pinyin: 'ƒì √© ƒõ √®', english: 'eh' },
                        description: 'Mid-central vowel sound',
                        videoId: 'kYHSH-pWjUw',
                        tips: 'Mouth slightly open, tongue in middle position'
                    },
                    {
                        id: 'vowel_i',
                        title: 'Vowel I (Ë°£)',
                        difficulty: 'beginner',
                        content: { chinese: 'Ë°£', pinyin: 'yƒ´ y√≠ y«ê y√¨', english: 'clothes' },
                        description: 'High front vowel sound',
                        videoId: 'kYHSH-pWjUw',
                        tips: 'Spread lips slightly, tongue high and forward'
                    },
                    {
                        id: 'vowel_u',
                        title: 'Vowel U (‰πå)',
                        difficulty: 'beginner',
                        content: { chinese: '‰πå', pinyin: 'w≈´ w√∫ w«î w√π', english: 'crow/dark' },
                        description: 'High back rounded vowel',
                        videoId: 'kYHSH-pWjUw',
                        tips: 'Round lips tightly, tongue high and back'
                    },
                    {
                        id: 'vowel_v',
                        title: 'Vowel √ú (È±º)',
                        difficulty: 'intermediate',
                        content: { chinese: 'È±º', pinyin: 'y√∫', english: 'fish' },
                        description: 'Rounded front vowel (like German √º)',
                        videoId: 'kYHSH-pWjUw',
                        tips: 'Say "ee" but round your lips like "oo"'
                    }
                ]
            },
            consonants: {
                title: "üí¨ Consonants (Â£∞ÊØç)",
                description: "Learn Mandarin initial consonant sounds",
                lessons: [
                    {
                        id: 'cons_b',
                        title: 'B Sound (Â∑¥)',
                        difficulty: 'beginner',
                        content: { chinese: 'Â∑¥', pinyin: 'bƒÅ', english: 'to hope' },
                        description: 'Unaspirated bilabial stop',
                        videoId: '3wCBQ54mhGU',
                        tips: 'Similar to English "b" but less forceful'
                    },
                    {
                        id: 'cons_p',
                        title: 'P Sound (ÊÄï)',
                        difficulty: 'beginner',
                        content: { chinese: 'ÊÄï', pinyin: 'p√†', english: 'to fear' },
                        description: 'Aspirated bilabial stop',
                        videoId: '3wCBQ54mhGU',
                        tips: 'Strong puff of air, like English "p" in "pin"'
                    },
                    {
                        id: 'cons_m',
                        title: 'M Sound (Â¶à)',
                        difficulty: 'beginner',
                        content: { chinese: 'Â¶à', pinyin: 'mƒÅ', english: 'mother' },
                        description: 'Bilabial nasal',
                        videoId: '3wCBQ54mhGU',
                        tips: 'Same as English "m"'
                    },
                    {
                        id: 'cons_f',
                        title: 'F Sound (Âèë)',
                        difficulty: 'beginner',
                        content: { chinese: 'Âèë', pinyin: 'fƒÅ', english: 'to emit' },
                        description: 'Voiceless labiodental fricative',
                        videoId: '3wCBQ54mhGU',
                        tips: 'Same as English "f"'
                    },
                    {
                        id: 'cons_d',
                        title: 'D Sound (Â§ß)',
                        difficulty: 'beginner',
                        content: { chinese: 'Â§ß', pinyin: 'd√†', english: 'big' },
                        description: 'Unaspirated alveolar stop',
                        videoId: '3wCBQ54mhGU',
                        tips: 'Similar to English "d" but less voiced'
                    },
                    {
                        id: 'cons_t',
                        title: 'T Sound (‰ªñ)',
                        difficulty: 'beginner',
                        content: { chinese: '‰ªñ', pinyin: 'tƒÅ', english: 'he/him' },
                        description: 'Aspirated alveolar stop',
                        videoId: '3wCBQ54mhGU',
                        tips: 'Strong puff of air, tongue tip on alveolar ridge'
                    }
                ]
            },
            tones: {
                title: "üéµ Tones (Â£∞Ë∞É)",
                description: "Master the 4 Mandarin tones",
                lessons: [
                    {
                        id: 'tone_1',
                        title: 'First Tone (‰∏ÄÂ£∞)',
                        difficulty: 'beginner',
                        content: { chinese: 'Â¶à', pinyin: 'mƒÅ', english: 'mother' },
                        description: 'High level tone (flat)',
                        videoId: 'tiScFONbHEg',
                        tips: 'Keep pitch high and steady, like singing a high note'
                    },
                    {
                        id: 'tone_2',
                        title: 'Second Tone (‰∫åÂ£∞)',
                        difficulty: 'beginner',
                        content: { chinese: 'È∫ª', pinyin: 'm√°', english: 'hemp/numb' },
                        description: 'Rising tone (like asking a question)',
                        videoId: 'tiScFONbHEg',
                        tips: 'Start mid-low, rise to high - like saying "what?" in English'
                    },
                    {
                        id: 'tone_3',
                        title: 'Third Tone (‰∏âÂ£∞)',
                        difficulty: 'intermediate',
                        content: { chinese: 'È©¨', pinyin: 'm«é', english: 'horse' },
                        description: 'Falling-rising tone (dip down, then up)',
                        videoId: 'tiScFONbHEg',
                        tips: 'Start mid, fall to low, then rise - like saying "oh" with doubt'
                    },
                    {
                        id: 'tone_4',
                        title: 'Fourth Tone (ÂõõÂ£∞)',
                        difficulty: 'beginner',
                        content: { chinese: 'È™Ç', pinyin: 'm√†', english: 'to scold' },
                        description: 'Falling tone (sharp drop)',
                        videoId: 'tiScFONbHEg',
                        tips: 'Start high, drop sharply - like a command "No!"'
                    },
                    {
                        id: 'tone_neutral',
                        title: 'Neutral Tone (ËΩªÂ£∞)',
                        difficulty: 'intermediate',
                        content: { chinese: 'Âêó', pinyin: 'ma', english: '(question particle)' },
                        description: 'Light, short, unstressed',
                        videoId: 'tiScFONbHEg',
                        tips: 'Short and light, no specific pitch pattern'
                    }
                ]
            },
            pinyin: {
                title: "üìù Pinyin System",
                description: "Complete pinyin romanization system",
                lessons: [
                    {
                        id: 'pinyin_intro',
                        title: 'Pinyin Basics',
                        difficulty: 'beginner',
                        content: { chinese: 'ÊãºÈü≥', pinyin: 'pƒ´nyƒ´n', english: 'pinyin' },
                        description: 'Introduction to pinyin romanization',
                        videoId: 'o-p4vrkwvXs',
                        tips: 'Pinyin uses Latin letters to represent Chinese sounds'
                    },
                    {
                        id: 'pinyin_rules',
                        title: 'Spelling Rules',
                        difficulty: 'intermediate',
                        content: { chinese: 'ËßÑÂàô', pinyin: 'guƒ´z√©', english: 'rules' },
                        description: 'Key pinyin spelling conventions',
                        videoId: 'o-p4vrkwvXs',
                        tips: 'Learn when to use j/q/x vs zh/ch/sh vs z/c/s'
                    }
                ]
            },
            basics: {
                title: "üåü Basic Words",
                description: "Essential vocabulary for beginners",
                lessons: [
                    {
                        id: 'greetings',
                        title: 'Greetings',
                        difficulty: 'beginner',
                        content: { chinese: '‰Ω†Â•Ω', pinyin: 'n«ê h«éo', english: 'hello' },
                        description: 'Common greetings and polite expressions',
                        videoId: 'rOzYLzEyJq4',
                        tips: 'Start with basic greetings - foundation of conversation'
                    },
                    {
                        id: 'numbers',
                        title: 'Numbers 1-10',
                        difficulty: 'beginner',
                        content: { chinese: '‰∏Ä‰∫å‰∏â', pinyin: 'yƒ´ √®r sƒÅn', english: 'one two three' },
                        description: 'Basic numbers for counting',
                        videoId: 'uLdxhV4TmM8',
                        tips: 'Numbers are essential - practice tone changes'
                    },
                    {
                        id: 'family',
                        title: 'Family Members',
                        difficulty: 'beginner',
                        content: { chinese: 'ÂÆ∂‰∫∫', pinyin: 'jiƒÅr√©n', english: 'family' },
                        description: 'Words for family relationships',
                        videoId: 'QefOQQb4XJk',
                        tips: 'Start with immediate family: Â¶àÂ¶à, Áà∏Áà∏, Âì•Âì•, ÂßêÂßê'
                    }
                ]
            },
            sentences: {
                title: "üí≠ Common Phrases",
                description: "Everyday expressions and sentences",
                lessons: [
                    {
                        id: 'intro_phrases',
                        title: 'Self Introduction',
                        difficulty: 'beginner',
                        content: { chinese: 'ÊàëÂè´...', pinyin: 'w«í ji√†o...', english: 'My name is...' },
                        description: 'Basic phrases for introducing yourself',
                        videoId: 'gdY2FfCK7OQ',
                        tips: 'Essential for first conversations'
                    },
                    {
                        id: 'daily_phrases',
                        title: 'Daily Expressions',
                        difficulty: 'beginner',
                        content: { chinese: 'Ë∞¢Ë∞¢', pinyin: 'xi√®xie', english: 'thank you' },
                        description: 'Common daily expressions',
                        videoId: 'gdY2FfCK7OQ',
                        tips: 'Use these phrases every day to build fluency'
                    }
                ]
            }
        };

        // Learning Hub Functions
        function selectCategory(category) {
            // Remove active class from all categories
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Add active class to selected category
            event.currentTarget.classList.add('active');
            
            // Show lesson content
            const lessonContent = document.getElementById('lesson-content');
            const categoryTitle = document.getElementById('category-title');
            const lessonGrid = document.getElementById('lesson-grid');
            
            const categoryData = LEARNING_CONTENT[category];
            
            categoryTitle.textContent = categoryData.title;
            lessonContent.style.display = 'block';
            
            // Populate lessons
            lessonGrid.innerHTML = categoryData.lessons.map(lesson => `
                <div class="lesson-card">
                    <div class="lesson-header">
                        <div class="lesson-icon">${getCategoryIcon(category)}</div>
                        <div class="lesson-info">
                            <h3>${lesson.title}
                                <span class="difficulty-badge difficulty-${lesson.difficulty}">
                                    ${lesson.difficulty.toUpperCase()}
                                </span>
                            </h3>
                            <p>${lesson.description}</p>
                        </div>
                    </div>
                    
                    <div class="lesson-content">
                        <div class="phonetic-display">
                            <div class="chinese-char">${lesson.content.chinese}</div>
                            <div class="pinyin">${lesson.content.pinyin}</div>
                            <div class="english">${lesson.content.english}</div>
                        </div>
                        
                        <div class="video-container">
                            <iframe src="https://www.youtube.com/embed/${lesson.videoId}?start=0&rel=0&modestbranding=1" 
                                    allowfullscreen>
                            </iframe>
                        </div>
                        
                        <p><strong>üí° Tip:</strong> ${lesson.tips}</p>
                    </div>
                    
                    <div class="practice-buttons">
                        <button class="btn-small btn-play" id="play-btn-${lesson.id}" onclick="playLessonAudio('${lesson.id}')">
                            üîä Listen
                        </button>
                        <button class="btn-small btn-practice" onclick="practiceLesson('${lesson.id}', '${category}')">
                            üé§ Practice
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Award XP for exploring content
            awardXP(5, `Exploring ${categoryData.title}! üìö`);
            
            // Scroll to content
            lessonContent.scrollIntoView({ behavior: 'smooth' });
        }

        function getCategoryIcon(category) {
            const icons = {
                vowels: 'üó£Ô∏è',
                consonants: 'üí¨',
                tones: 'üéµ',
                pinyin: 'üìù',
                basics: 'üåü',
                sentences: 'üí≠'
            };
            return icons[category] || 'üìö';
        }

        function playLessonAudio(lessonId) {
            // Find the lesson data
            let lesson = null;
            let category = null;
            
            // Search through all categories to find the lesson
            for (const [catKey, catData] of Object.entries(LEARNING_CONTENT)) {
                const foundLesson = catData.lessons.find(l => l.id === lessonId);
                if (foundLesson) {
                    lesson = foundLesson;
                    category = catKey;
                    break;
                }
            }
            
            if (!lesson) {
                showAIMessage("‚ùå Lesson not found!");
                return;
            }
            
            // Use Web Speech API to generate pronunciation
            if ('speechSynthesis' in window) {
                // Stop any currently playing speech
                speechSynthesis.cancel();
                
                // Create speech utterance
                const utterance = new SpeechSynthesisUtterance();
                
                // Set the text to speak (use pinyin for better pronunciation)
                const textToSpeak = lesson.content.chinese + ". " + lesson.content.pinyin;
                utterance.text = textToSpeak;
                
                // Try to find a Chinese voice
                const voices = speechSynthesis.getVoices();
                const chineseVoice = voices.find(voice => 
                    voice.lang.includes('zh') || 
                    voice.lang.includes('cmn') ||
                    voice.name.toLowerCase().includes('chinese') ||
                    voice.name.toLowerCase().includes('mandarin')
                );
                
                if (chineseVoice) {
                    utterance.voice = chineseVoice;
                    utterance.lang = chineseVoice.lang;
                } else {
                    // Fallback to default voice with Chinese language setting
                    utterance.lang = 'zh-CN';
                }
                
                // Set speech parameters for clear pronunciation
                utterance.rate = 0.7; // Slower for learning
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                // Add event listeners
                utterance.onstart = function() {
                    const playBtn = document.getElementById(`play-btn-${lessonId}`);
                    if (playBtn) {
                        playBtn.innerHTML = '‚èπÔ∏è Stop';
                        playBtn.style.background = '#FF6B35';
                        playBtn.onclick = function() { 
                            speechSynthesis.cancel();
                            playBtn.innerHTML = 'üîä Listen';
                            playBtn.style.background = '#4CAF50';
                            playBtn.onclick = function() { playLessonAudio(lessonId); };
                        };
                    }
                    showAIMessage(`üîä Playing: ${lesson.content.chinese} (${lesson.content.pinyin})`);
                };
                
                utterance.onend = function() {
                    const playBtn = document.getElementById(`play-btn-${lessonId}`);
                    if (playBtn) {
                        playBtn.innerHTML = 'üîä Listen';
                        playBtn.style.background = '#4CAF50';
                        playBtn.onclick = function() { playLessonAudio(lessonId); };
                    }
                    showAIMessage("‚úÖ Audio finished! Try practicing now! üé§");
                    awardXP(2, "Listening to pronunciation! üëÇ");
                };
                
                utterance.onerror = function(event) {
                    console.error('Speech synthesis error:', event.error);
                    const playBtn = document.getElementById(`play-btn-${lessonId}`);
                    if (playBtn) {
                        playBtn.innerHTML = 'üîä Listen';
                        playBtn.style.background = '#4CAF50';
                        playBtn.onclick = function() { playLessonAudio(lessonId); };
                    }
                    showAIMessage("‚ùå Audio playback failed. Using fallback method...");
                    playFallbackAudio(lesson);
                };
                
                // Speak the text
                speechSynthesis.speak(utterance);
                
            } else {
                // Fallback for browsers without speech synthesis
                showAIMessage("‚ùå Speech synthesis not supported. Using fallback...");
                playFallbackAudio(lesson);
            }
        }
        
        function playFallbackAudio(lesson) {
            // Create a simple tone-based audio feedback
            if ('AudioContext' in window || 'webkitAudioContext' in window) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const audioContext = new AudioContext();
                
                // Generate a simple tone sequence to represent the tones
                const duration = 0.8;
                const frequencies = getToneFrequencies(lesson.content.pinyin);
                
                frequencies.forEach((freq, index) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(freq, audioContext.currentTime + index * 0.3);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime + index * 0.3);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + index * 0.3 + duration);
                    
                    oscillator.start(audioContext.currentTime + index * 0.3);
                    oscillator.stop(audioContext.currentTime + index * 0.3 + duration);
                });
                
                showAIMessage(`üéµ Playing tone pattern for: ${lesson.content.pinyin}`);
                awardXP(2, "Listening to tone pattern! üéµ");
            } else {
                // Final fallback - just show the text
                showAIMessage(`üìñ Pronunciation: ${lesson.content.chinese} = ${lesson.content.pinyin} (${lesson.content.english})`);
                awardXP(1, "Studying pronunciation! ÔøΩ");
            }
        }
        
        function getToneFrequencies(pinyin) {
            // Extract tone marks and generate corresponding frequencies
            const frequencies = [];
            const baseFreq = 200; // Base frequency in Hz
            
            // Simple tone pattern mapping
            if (pinyin.includes('ƒÅ') || pinyin.includes('ƒì') || pinyin.includes('ƒ´') || pinyin.includes('≈ç') || pinyin.includes('≈´') || pinyin.includes('«ñ')) {
                // Tone 1: High level
                frequencies.push(baseFreq * 1.5, baseFreq * 1.5, baseFreq * 1.5);
            } else if (pinyin.includes('√°') || pinyin.includes('√©') || pinyin.includes('√≠') || pinyin.includes('√≥') || pinyin.includes('√∫') || pinyin.includes('«ò')) {
                // Tone 2: Rising
                frequencies.push(baseFreq, baseFreq * 1.3, baseFreq * 1.6);
            } else if (pinyin.includes('«é') || pinyin.includes('ƒõ') || pinyin.includes('«ê') || pinyin.includes('«í') || pinyin.includes('«î') || pinyin.includes('«ö')) {
                // Tone 3: Falling-rising
                frequencies.push(baseFreq * 1.2, baseFreq * 0.8, baseFreq * 1.4);
            } else if (pinyin.includes('√†') || pinyin.includes('√®') || pinyin.includes('√¨') || pinyin.includes('√≤') || pinyin.includes('√π') || pinyin.includes('«ú')) {
                // Tone 4: Falling
                frequencies.push(baseFreq * 1.6, baseFreq * 1.2, baseFreq * 0.8);
            } else {
                // Neutral tone or no tone marks
                frequencies.push(baseFreq, baseFreq, baseFreq);
            }
            
            return frequencies;
        }
        
        // Initialize speech synthesis voices when page loads
        function initializeSpeech() {
            if ('speechSynthesis' in window) {
                // Load voices
                speechSynthesis.getVoices();
                
                // Some browsers require user interaction first
                document.addEventListener('click', function() {
                    speechSynthesis.getVoices();
                }, { once: true });
                
                // Chrome requires this event listener to load voices
                speechSynthesis.addEventListener('voiceschanged', function() {
                    const voices = speechSynthesis.getVoices();
                    console.log('Available voices:', voices.length);
                    
                    // Log Chinese voices for debugging
                    const chineseVoices = voices.filter(voice => 
                        voice.lang.includes('zh') || 
                        voice.name.toLowerCase().includes('chinese')
                    );
                    
                    if (chineseVoices.length > 0) {
                        console.log('Chinese voices found:', chineseVoices.map(v => v.name));
                        showAIMessage(`üéØ Found ${chineseVoices.length} Chinese voice(s) for pronunciation!`);
                    } else {
                        console.log('No Chinese voices found, will use default with Chinese language setting');
                    }
                });
            }
        }

        function practiceLesson(lessonId, category) {
            // Create a temporary lesson for practice mode
            const categoryData = LEARNING_CONTENT[category];
            const lesson = categoryData.lessons.find(l => l.id === lessonId);
            
            if (!lesson) return;
            
            // Create a temporary lesson object for the practice system
            const tempLesson = {
                id: Date.now(),
                title: lesson.title,
                type: 'learning',
                text: `${lesson.content.chinese} (${lesson.content.pinyin}) - ${lesson.content.english}`,
                audioData: null // In real system, would have teacher audio
            };
            
            // Switch to student mode and set up practice
            currentLesson = tempLesson;
            switchMode('student');
            
            // Show practice area
            document.getElementById('practice-area').style.display = 'block';
            document.getElementById('current-lesson-title').textContent = lesson.title;
            document.getElementById('current-lesson-text').textContent = tempLesson.text;
            
            // Show master audio placeholder
            document.getElementById('master-audio-player').innerHTML = `
                <div class="audio-placeholder">
                    <p>üéØ Practice saying: <strong>${lesson.content.pinyin}</strong></p>
                    <p>üí° ${lesson.tips}</p>
                </div>
            `;
            
            showAIMessage(`ÂáÜÂ§áÂ•Ω‰∫ÜÂêó? Ready for ${lesson.title}! ÂºÄÂßãÂΩïÈü≥! üé§`);
            awardXP(3, "Starting practice session! üí™");
        }

        // Mode switching
        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.mode-btn.${mode}`).classList.add('active');
            
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(`${mode}-section`).classList.add('active');
            
            if (mode === 'student') {
                loadLessons();
                updateDashboard();
            } else if (mode === 'learning') {
                showAIMessage("Ê¨¢ËøéÊù•Âà∞ Learning Hub! Pick a category! Â≠¶‰π†Êó∂Èó¥Âà∞‰∫Ü! üìö");
                awardXP(2, "Exploring Learning Hub! üöÄ");
            }
        }

        // Load Lessons
        function loadLessons() {
            const teacherList = document.getElementById('teacher-lessons-list');
            const practiceList = document.getElementById('practice-lessons-list');

            // Check if student has selected a class
            if (!currentStudentClass) {
                teacherList.innerHTML = '<p style="text-align: center; color: #666;">Please select your grade and class to see lessons assigned by your teacher.<br><strong>Important:</strong> You must select the exact same grade your teacher assigned lessons to.</p>';
                practiceList.innerHTML = '<p style="text-align: center; color: #666;">Select your class first to access practice lessons.</p>';
                return;
            }

            // Load lessons from teacher portal
            const teacherLessons = JSON.parse(localStorage.getItem('teacherLessons') || '[]');
            
            // Separate teacher-assigned lessons from practice lessons
            const assignedLessons = teacherLessons.filter(lesson => 
                lesson.teacherClass === currentStudentClass
            );
            
            const practiceLessons = lessons.filter(lesson => 
                !lesson.teacherClass || lesson.isPublic
            );

            // Clear both lists
            teacherList.innerHTML = '';
            practiceList.innerHTML = '';

            // Display teacher-assigned lessons
            if (assignedLessons.length === 0) {
                teacherList.innerHTML = `<p style="color: #2e7d32; text-align: center; font-style: italic;">
                    üìã No lessons assigned yet for ${currentStudentClass}.<br>
                    Your teacher will assign lessons soon. Check back later!
                </p>`;
            } else {
                assignedLessons.forEach(lesson => {
                    const teacherItem = createLessonItem(lesson, true);
                    teacherItem.style.background = 'linear-gradient(135deg, #f8fff8 0%, #f0f8ff 100%)';
                    teacherItem.style.border = '2px solid #4caf50';
                    teacherList.appendChild(teacherItem);
                });
                
                showAIMessage(`üìö Found ${assignedLessons.length} lesson${assignedLessons.length === 1 ? '' : 's'} assigned by your teacher for ${currentStudentClass}!`);
            }

            // Display practice lessons
            if (practiceLessons.length === 0) {
                practiceList.innerHTML = `<p style="color: #999; text-align: center;">No practice lessons available at the moment.</p>`;
            } else {
                practiceLessons.forEach(lesson => {
                    const practiceItem = createLessonItem(lesson, true);
                    practiceList.appendChild(practiceItem);
                });
            }

            // Show count of filtered lessons
            if (classFilteredLessons.length > 0) {
                showAIMessage(`Found ${classFilteredLessons.length} lesson${classFilteredLessons.length === 1 ? '' : 's'} for ${currentStudentClass}! üìö`);
                
                // Debug info (can be removed in production)
                console.log(`üìö Lessons loaded for ${currentStudentClass}:`, classFilteredLessons);
            }
        }

        function createLessonItem(lesson, isStudent) {
            const li = document.createElement('li');
            li.className = 'lesson-item';
            
            // Handle both old and new lesson formats
            const title = lesson.title || 'Untitled Lesson';
            const type = lesson.category || lesson.type || 'lesson';
            const text = lesson.text || '';
            const difficulty = lesson.difficulty ? ` - ${lesson.difficulty}` : '';
            const source = lesson.teacherName ? ` (by ${lesson.teacherName})` : '';
            const classInfo = lesson.teacherClass ? ` üìö ${lesson.teacherClass}` : '';
            
            li.innerHTML = `
                <strong>${title}</strong> (${type}${difficulty})<br>
                <small>${text}${source}${classInfo}</small>
                ${lesson.notes ? `<br><em style="color: #666;">${lesson.notes}</em>` : ''}
            `;

            if (isStudent) {
                li.onclick = () => selectLesson(lesson);
            }

            return li;
        }

        // Select Lesson for Practice
        function selectLesson(lesson) {
            currentLesson = lesson;
            
            document.querySelectorAll('#teacher-lessons-list .lesson-item, #practice-lessons-list .lesson-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.lesson-item').classList.add('selected');

            document.getElementById('practice-area').style.display = 'block';
            document.getElementById('results-area').style.display = 'none';
            document.getElementById('current-lesson-title').textContent = `üìù ${lesson.title}`;
            document.getElementById('current-lesson-text').textContent = lesson.text;

            // Show student instructions if available
            if (lesson.studentInstructions && lesson.studentInstructions.trim()) {
                document.getElementById('student-instructions-text').textContent = lesson.studentInstructions;
                document.getElementById('student-instructions-section').style.display = 'block';
            } else {
                document.getElementById('student-instructions-section').style.display = 'none';
            }

            // Load master audio if available
            if (lesson.audioData) {
                document.getElementById('master-audio-player').innerHTML = `
                    <div style="text-align: center;">
                        <p style="margin-bottom: 15px; color: #2e7d32; font-weight: bold;">üéØ Listen to the correct pronunciation:</p>
                        <audio controls class="audio-player" style="width: 100%; max-width: 400px;">
                            <source src="${lesson.audioData}" type="audio/wav">
                            <source src="${lesson.audioData}" type="audio/mp3">
                            <source src="${lesson.audioData}" type="audio/ogg">
                            Your browser does not support the audio element.
                        </audio>
                        <p style="margin-top: 10px; font-size: 0.9em; color: #666;">üí° Play this recording and try to match the pronunciation</p>
                    </div>
                `;
                document.getElementById('master-audio-section').style.display = 'block';
            } else {
                document.getElementById('master-audio-player').innerHTML = `
                    <div style="text-align: center; color: #666;">
                        <p>üì¢ No master recording available for this lesson</p>
                        <p style="font-size: 0.9em;">Your teacher will provide audio recordings for better practice!</p>
                    </div>
                `;
                document.getElementById('master-audio-section').style.display = 'block';
            }

            // Reset student recording
            document.getElementById('student-audio-preview').innerHTML = '';
            document.getElementById('analyze-btn').disabled = true;
            studentAudioBlob = null;
            
            // Show encouraging message
            showAIMessage(`Great choice! Practice pronouncing "${lesson.text}" and I'll analyze your pronunciation! üéØ`);
        }

        // Student Recording Functions
        async function startStudentRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    studentAudioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(studentAudioBlob);
                    
                    document.getElementById('student-audio-preview').innerHTML = `
                        <audio controls class="audio-player" src="${audioUrl}"></audio>
                    `;
                    
                    document.getElementById('analyze-btn').disabled = false;
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                document.getElementById('student-record-btn').disabled = true;
                document.getElementById('student-stop-btn').disabled = false;
                document.getElementById('student-record-btn').innerHTML = '<span class="recording-indicator"></span> Recording...';
            } catch (error) {
                alert('Error accessing microphone: ' + error.message);
            }
        }

        function stopStudentRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                document.getElementById('student-record-btn').disabled = false;
                document.getElementById('student-stop-btn').disabled = true;
                document.getElementById('student-record-btn').innerHTML = 'üé§ Start Recording';
            }
        }

        // Analyze Recording with Advanced AI
        async function analyzeRecording() {
            if (!studentAudioBlob || !currentLesson) {
                showNotification('Please record your pronunciation first!', 'error');
                return;
            }

            const analyzeBtn = document.getElementById('analyze-btn');
            
            try {

            document.getElementById('analyze-btn').disabled = true;
            document.getElementById('analyze-btn').innerHTML = '<span class="loading"></span> AI ËÄÅÂ∏à is listening...';

            // Fun AI processing simulation - quick and reliable!
            await new Promise(resolve => setTimeout(resolve, 800));

            // Generate fun, engaging analysis (70-100 score range)
            const analysisResult = generateFunAnalysis();
            
            // Display fun results with animations
            displayFunResults(analysisResult);

            // Save to history with XP rewards
            savePracticeSession(analysisResult.score);
            awardXP(Math.floor(analysisResult.score / 8), "Excellent Pronunciation! ÔøΩ");

            document.getElementById('analyze-btn').disabled = false;
            document.getElementById('analyze-btn').innerHTML = 'üîç Analyze My Pronunciation';
            
            // Show fun encouraging AI message
            setTimeout(() => {
                showAIMessage(getFunEncouragementMessage(analysisResult.score));
            }, 800);

            } catch (error) {
                console.error('Analysis error:', error);
                showNotification('Analysis completed with basic feedback!', 'info');
                
                // Fallback analysis
                const fallbackResult = generateSimplifiedRealisticAnalysis();
                displayAdvancedResults(fallbackResult);
                savePracticeSession(fallbackResult.score);
            } finally {
                // Always re-enable the button
                if (analyzeBtn) {
                    analyzeBtn.disabled = false;
                    analyzeBtn.innerHTML = 'üîç Analyze My Pronunciation';
                }
            }
        }

        // Fun AI Analysis Generator (70-100 score range)
        function generateFunAnalysis() {
            const lessonText = currentLesson.text || currentLesson.title || "Hello";
            const lessonLength = lessonText.length;
            
            // Generate score between 70-100 (always encouraging!)
            const baseScore = 70 + Math.random() * 30;
            const score = Math.round(baseScore);
            
            // Fun feedback based on score ranges
            let praise, improvement, funFact, nextChallenge;
            
            if (score >= 95) {
                praise = ["Âìá! WOW! You're like a native speaker! üåü", "Â§™Ê£í‰∫Ü! Absolutely phenomenal! You've mastered this! üéâ", "‰∏çÂèØÊÄùËÆÆ! Incredible! Your pronunciation is spot-on! ‚ú®"];
                improvement = ["You're already amazing! Keep practicing to maintain this level!", "Try teaching others - you're ready to be a pronunciation mentor!", "Challenge yourself with tongue twisters next!"];
                funFact = ["Fun fact: You just scored higher than 95% of learners! üèÜ", "Did you know? Native speakers would be impressed by your pronunciation! üé≠", "Amazing: Your tone accuracy rivals professional Mandarin teachers! üìö"];
            } else if (score >= 85) {
                praise = ["ÂæàÂ•Ω! Excellent work! You're really getting it! üéØ", "Ê£íÊûÅ‰∫Ü! Fantastic! Your pronunciation is getting stronger! üí™", "‰∫Ü‰∏çËµ∑! Outstanding! You're making great progress! üöÄ"];
                improvement = ["Focus on the tone changes - you're almost there!", "Try speaking a bit slower for even better clarity!", "Practice the rhythm - you're so close to perfection!"];
                funFact = ["Fun fact: You're in the top 20% of Mandarin learners! üåü", "Did you know? Your pronunciation confidence is showing! üòä", "Cool: You're ready for real conversations with native speakers! üó£Ô∏è"];
            } else if (score >= 75) {
                praise = ["Â•ΩÁöÑ! Good job! You're on the right track! üëç", "‰∏çÈîô! Nice work! I can hear the improvement! üìà", "ÂæàÊ£í! Great effort! You're building strong foundations! üèóÔ∏è"];
                improvement = ["Listen to the master recording again and match the rhythm!", "Focus on your tongue position for clearer sounds!", "Try recording multiple times - practice makes perfect!"];
                funFact = ["Fun fact: Every mistake is actually your brain learning! üß†", "Did you know? You're already better than when you started! üìä", "Cool: Chinese has only 4 tones - you're mastering them! üéµ"];
            } else {
                praise = ["Âä†Ê≤π! Keep going! Every attempt makes you better! üí™", "Â•ΩÁöÑÂºÄÂßã! Good start! You're brave to practice! üå±", "ÂæàÂ•ΩÁöÑÂ∞ùËØï! Great try! Learning takes courage! ü¶Å"];
                improvement = ["Listen carefully to the master recording first!", "Break down the phrase into smaller parts!", "Don't worry about perfection - focus on confidence!"];
                funFact = ["Fun fact: Even native speakers had to learn these sounds as babies! üë∂", "Did you know? Your brain is creating new pathways right now! ‚ö°", "Cool: Every 'mistake' is actually data for your learning! üî¨"];
            }
            
            return {
                score: score,
                grade: score >= 95 ? "A+" : score >= 85 ? "A" : score >= 75 ? "B+" : "B",
                lessonText: lessonText,
                praise: praise[Math.floor(Math.random() * praise.length)],
                improvement: improvement[Math.floor(Math.random() * improvement.length)],
                funFact: funFact[Math.floor(Math.random() * funFact.length)],
                nextChallenge: getNextChallenge(score),
                emoji: score >= 95 ? "üèÜ" : score >= 85 ? "üåü" : score >= 75 ? "üéØ" : "üí™",
                chineseEncouragement: getChineseEncouragement(score)
            };
        }

        function getNextChallenge(score) {
            const challenges = [
                "Try saying it with different emotions! üòäüòÆüòç",
                "Challenge: Say it 3 times fast! ‚ö°",
                "Next level: Add hand gestures while speaking! üëã",
                "Fun challenge: Whisper it, then shout it! üîä",
                "Advanced: Teach it to someone else! üë®‚Äçüè´",
                "Super challenge: Say it while smiling! üòÑ"
            ];
            return challenges[Math.floor(Math.random() * challenges.length)];
        }

        function getChineseEncouragement(score) {
            const encouragements = [
                "Âä†Ê≤π! (jiƒÅ y√≥u) - Keep it up!",
                "Â§™Ê£í‰∫Ü! (t√†i b√†ng le) - Awesome!",
                "ÂæàÂ•Ω! (hƒõn h«éo) - Very good!",
                "‰∫Ü‰∏çËµ∑! (li«éo bu q«ê) - Amazing!",
                "ÁªßÁª≠Âä™Âäõ! (j√¨ x√π n«î l√¨) - Keep working hard!",
                "‰Ω†ÂæàÊ£í! (n«ê hƒõn b√†ng) - You're great!"
            ];
            return encouragements[Math.floor(Math.random() * encouragements.length)];
        }

        // Simplified realistic analysis to avoid hanging issues
        function generateSimplifiedRealisticAnalysis() {
            const lessonText = currentLesson.text || currentLesson.title || "Hello";
            const complexity = lessonText.length > 20 ? 'advanced' : lessonText.length > 10 ? 'intermediate' : 'beginner';
            
            // Generate realistic score without complex audio analysis
            const baseScore = 40 + Math.random() * 55; // 40-95 range
            const score = Math.round(baseScore);
            
            return {
                score: score,
                grade: getGradeFromScore(score),
                lessonText: lessonText,
                complexity: complexity,
                strengths: generateStrengths(score),
                improvements: generateImprovements(score),
                toneAnalysis: generateToneAnalysis(),
                pronunciationTips: generatePronunciationTips(lessonText),
                nextSteps: generateNextSteps(score)
            };
        }

        // Generate realistic audio analysis with actual scoring
        async function generateRealisticAnalysis() {
            const lessonText = currentLesson.text || currentLesson.title || "Hello";
            const complexity = lessonText.length > 20 ? 'advanced' : lessonText.length > 10 ? 'intermediate' : 'beginner';
            
            // Perform actual audio analysis
            const audioAnalysis = await analyzeAudioBlob(studentAudioBlob);
            
            // Calculate realistic score based on audio features
            const score = calculateRealisticScore(audioAnalysis, lessonText, complexity);
            
            return {
                score: score,
                grade: getGradeFromScore(score),
                lessonText: lessonText,
                complexity: complexity,
                strengths: generateStrengths(score),
                improvements: generateImprovements(score),
                toneAnalysis: generateToneAnalysis(),
                pronunciationTips: generatePronunciationTips(lessonText),
                nextSteps: generateNextSteps(score)
            };
        }

        // Realistic Audio Analysis Functions
        async function analyzeAudioBlob(audioBlob) {
            return new Promise((resolve) => {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const reader = new FileReader();
                
                reader.onload = async function() {
                    try {
                        const arrayBuffer = reader.result;
                        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                        
                        // Extract real audio features
                        const features = extractAudioFeatures(audioBuffer);
                        resolve(features);
                    } catch (error) {
                        console.log('Audio analysis fallback to simulation');
                        // Fallback to simulated analysis
                        resolve(simulateAudioFeatures());
                    }
                };
                
                reader.readAsArrayBuffer(audioBlob);
            });
        }

        function extractAudioFeatures(audioBuffer) {
            const channelData = audioBuffer.getChannelData(0);
            const sampleRate = audioBuffer.sampleRate;
            const duration = audioBuffer.duration;
            
            // Calculate fundamental frequency (pitch)
            const fundamentalFreq = estimateFundamentalFrequency(channelData, sampleRate);
            
            // Calculate volume/amplitude metrics
            const volumeMetrics = calculateVolumeMetrics(channelData);
            
            // Calculate spectral features
            const spectralFeatures = calculateSpectralFeatures(channelData, sampleRate);
            
            // Calculate rhythm and timing
            const rhythmFeatures = calculateRhythmFeatures(channelData, sampleRate);
            
            return {
                duration: duration,
                fundamentalFreq: fundamentalFreq,
                volume: volumeMetrics,
                spectral: spectralFeatures,
                rhythm: rhythmFeatures,
                quality: assessAudioQuality(channelData, fundamentalFreq)
            };
        }

        function estimateFundamentalFrequency(channelData, sampleRate) {
            // Simple autocorrelation-based pitch detection
            const minPeriod = Math.floor(sampleRate / 800); // ~800Hz max
            const maxPeriod = Math.floor(sampleRate / 80);  // ~80Hz min
            
            let bestPeriod = 0;
            let bestCorrelation = 0;
            
            for (let period = minPeriod; period < maxPeriod; period++) {
                let correlation = 0;
                let samples = Math.min(channelData.length - period, sampleRate * 0.1); // 100ms window
                
                for (let i = 0; i < samples; i++) {
                    correlation += channelData[i] * channelData[i + period];
                }
                
                correlation = correlation / samples;
                
                if (correlation > bestCorrelation) {
                    bestCorrelation = correlation;
                    bestPeriod = period;
                }
            }
            
            return bestPeriod > 0 ? sampleRate / bestPeriod : 150; // Default ~150Hz
        }

        function calculateVolumeMetrics(channelData) {
            let sum = 0;
            let peak = 0;
            let rms = 0;
            
            for (let i = 0; i < channelData.length; i++) {
                const abs = Math.abs(channelData[i]);
                sum += abs;
                peak = Math.max(peak, abs);
                rms += channelData[i] * channelData[i];
            }
            
            return {
                average: sum / channelData.length,
                peak: peak,
                rms: Math.sqrt(rms / channelData.length),
                dynamicRange: peak - (sum / channelData.length)
            };
        }

        function calculateSpectralFeatures(channelData, sampleRate) {
            // Simple spectral analysis
            const windowSize = 1024;
            let spectralCentroid = 0;
            let spectralSpread = 0;
            
            // Calculate spectral centroid (brightness)
            for (let i = 0; i < Math.min(windowSize, channelData.length); i++) {
                spectralCentroid += i * Math.abs(channelData[i]);
            }
            spectralCentroid /= windowSize;
            
            return {
                centroid: spectralCentroid,
                spread: spectralSpread,
                brightness: spectralCentroid / (sampleRate / 2) // Normalized brightness
            };
        }

        function calculateRhythmFeatures(channelData, sampleRate) {
            // Detect speech rhythm patterns
            const windowSize = Math.floor(sampleRate * 0.05); // 50ms windows
            const energyWindows = [];
            
            for (let i = 0; i < channelData.length - windowSize; i += windowSize) {
                let energy = 0;
                for (let j = 0; j < windowSize; j++) {
                    energy += channelData[i + j] * channelData[i + j];
                }
                energyWindows.push(energy);
            }
            
            // Calculate rhythm regularity
            let rhythmScore = 0.5; // Default moderate rhythm
            if (energyWindows.length > 2) {
                const variance = calculateVariance(energyWindows);
                rhythmScore = Math.max(0, Math.min(1, 1 - (variance / 0.1)));
            }
            
            return {
                regularity: rhythmScore,
                tempo: estimateTempo(energyWindows),
                pauses: countPauses(energyWindows)
            };
        }

        function assessAudioQuality(channelData, fundamentalFreq) {
            // Assess overall audio quality
            const signalLevel = calculateVolumeMetrics(channelData).rms;
            const noiseFloor = estimateNoiseFloor(channelData);
            const snr = signalLevel / (noiseFloor + 0.001); // Signal-to-noise ratio
            
            // Quality score based on various factors
            let qualityScore = 0.5;
            
            // Good signal level (not too quiet, not clipping)
            if (signalLevel > 0.1 && signalLevel < 0.9) qualityScore += 0.2;
            
            // Good SNR
            if (snr > 10) qualityScore += 0.2;
            
            // Reasonable fundamental frequency
            if (fundamentalFreq > 80 && fundamentalFreq < 400) qualityScore += 0.1;
            
            return Math.min(1, qualityScore);
        }

        function simulateAudioFeatures() {
            // Fallback simulation if real analysis fails
            return {
                duration: 2.5,
                fundamentalFreq: 120 + Math.random() * 100,
                volume: {
                    average: 0.3 + Math.random() * 0.3,
                    peak: 0.6 + Math.random() * 0.3,
                    rms: 0.25 + Math.random() * 0.25
                },
                spectral: {
                    centroid: 0.3 + Math.random() * 0.4,
                    brightness: 0.4 + Math.random() * 0.3
                },
                rhythm: {
                    regularity: 0.6 + Math.random() * 0.3,
                    tempo: 120 + Math.random() * 40
                },
                quality: 0.7 + Math.random() * 0.25
            };
        }

        function calculateRealisticScore(audioFeatures, lessonText, complexity) {
            let baseScore = 50; // Start with 50
            
            // Audio quality factors (0-30 points)
            baseScore += audioFeatures.quality * 30;
            
            // Volume appropriateness (0-15 points)
            if (audioFeatures.volume.average > 0.1 && audioFeatures.volume.average < 0.8) {
                baseScore += 15;
            } else {
                baseScore += Math.max(0, 15 - Math.abs(audioFeatures.volume.average - 0.4) * 30);
            }
            
            // Pitch/frequency appropriateness (0-20 points)
            const targetFreq = 150; // Approximate target for Mandarin
            const freqDeviation = Math.abs(audioFeatures.fundamentalFreq - targetFreq) / targetFreq;
            baseScore += Math.max(0, 20 * (1 - freqDeviation));
            
            // Duration appropriateness (0-10 points)
            const expectedDuration = lessonText.length * 0.15; // ~0.15s per character
            const durationDeviation = Math.abs(audioFeatures.duration - expectedDuration) / expectedDuration;
            baseScore += Math.max(0, 10 * (1 - durationDeviation));
            
            // Rhythm and flow (0-15 points)  
            baseScore += audioFeatures.rhythm.regularity * 15;
            
            // Complexity adjustment
            if (complexity === 'beginner') baseScore += 5;
            if (complexity === 'advanced') baseScore -= 5;
            
            // Random variation (¬±5 points)
            baseScore += (Math.random() - 0.5) * 10;
            
            // Ensure score is between 40-95
            return Math.max(40, Math.min(95, Math.round(baseScore)));
        }

        // Helper functions
        function calculateVariance(array) {
            const mean = array.reduce((a, b) => a + b, 0) / array.length;
            return array.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / array.length;
        }

        function estimateTempo(energyWindows) {
            // Simple tempo estimation
            return 120 + (Math.random() - 0.5) * 40; // 100-140 BPM range
        }

        function countPauses(energyWindows) {
            const threshold = 0.01;
            return energyWindows.filter(energy => energy < threshold).length;
        }

        function estimateNoiseFloor(channelData) {
            // Estimate background noise level
            const sortedSamples = [...channelData].map(Math.abs).sort((a, b) => a - b);
            return sortedSamples[Math.floor(sortedSamples.length * 0.1)]; // 10th percentile
        }

        // AI Feedback Generation Functions
        function getGradeFromScore(score) {
            if (score >= 90) return { letter: 'A+', label: 'Excellent', color: '#4CAF50' };
            if (score >= 85) return { letter: 'A', label: 'Very Good', color: '#8BC34A' };
            if (score >= 80) return { letter: 'B+', label: 'Good', color: '#CDDC39' };
            if (score >= 75) return { letter: 'B', label: 'Above Average', color: '#FFC107' };
            if (score >= 70) return { letter: 'C+', label: 'Average', color: '#FF9800' };
            if (score >= 65) return { letter: 'C', label: 'Below Average', color: '#FF5722' };
            return { letter: 'D', label: 'Need Practice', color: '#F44336' };
        }

        function generateStrengths(score) {
            const excellentStrengths = [
                "Outstanding tone accuracy - your pitch control is exceptional!", 
                "Perfect consonant pronunciation - crystal clear articulation!",
                "Excellent natural rhythm and flow - sounds very native-like!",
                "Superb vowel sounds - precise and authentic!",
                "Strong confident voice projection - very engaging!",
                "Perfect pace and timing - excellent sense of rhythm!",
                "Crystal clear articulation - every sound is distinct!",
                "Very confident delivery - you sound like a natural speaker!",
                "Excellent breath control - smooth and effortless!",
                "Outstanding pitch variation - perfect tonal control!",
                "Seamless sound transitions - very fluent!",
                "Near-native intonation - incredibly authentic!"
            ];
            
            const goodStrengths = [
                "Clear consonant pronunciation", "Good tone accuracy", "Natural rhythm and flow",
                "Excellent vowel sounds", "Strong voice projection", "Good pace and timing",
                "Clear articulation", "Confident delivery", "Proper breath control",
                "Accurate pitch variation", "Good sound transitions", "Native-like intonation"
            ];
            
            // Since scores are now 80-98, always show excellent strengths
            const strengthsToUse = score >= 85 ? excellentStrengths : goodStrengths;
            const count = score > 90 ? 4 : 3;
            return strengthsToUse.sort(() => 0.5 - Math.random()).slice(0, count);
        }

        function generateImprovements(score) {
            const minorImprovements = [
                "Try slight variations in tone intensity for even more expressiveness",
                "Experiment with different speaking speeds to add variety",
                "Consider adding subtle emotional nuances to your pronunciation",
                "Practice with longer sentences to maintain this excellent level",
                "Try more complex vocabulary to challenge your skills further",
                "Focus on maintaining consistency across different contexts"
            ];
            
            const regularImprovements = [
                "Fine-tune tone accuracy - focus on the subtle differences between tones",
                "Polish vowel clarity - make each sound perfectly distinct",
                "Refine consonant sounds - perfect the 'zh', 'ch', 'sh' pronunciation",
                "Enhance rhythm consistency - maintain even flow throughout",
                "Boost voice confidence - you're doing great, project even more!",
                "Smooth out sound transitions - blend syllables seamlessly"
            ];
            
            // For high scores (80-98), give gentle refinement suggestions
            const improvementsToUse = score >= 90 ? minorImprovements : regularImprovements;
            const count = score >= 95 ? 1 : score >= 85 ? 2 : 2;
            return improvementsToUse.sort(() => 0.5 - Math.random()).slice(0, count);
        }

        function generateToneAnalysis() {
            const tones = ['First Tone (flat)', 'Second Tone (rising)', 'Third Tone (dip)', 'Fourth Tone (falling)'];
            const accuracy = Math.random() * 18 + 82; // 82-100% for optimistic feedback
            const strongTone = tones[Math.floor(Math.random() * tones.length)];
            const refineTone = tones[Math.floor(Math.random() * tones.length)];
            
            const roundedAccuracy = Math.round(accuracy);
            
            return {
                overall: roundedAccuracy,
                strongest: strongTone,
                needsWork: refineTone,
                tip: roundedAccuracy >= 95 ? 
                    `Excellent tonal control! Your ${strongTone.toLowerCase()} is particularly impressive!` :
                    roundedAccuracy >= 85 ?
                    `Great tonal accuracy! Fine-tune your ${refineTone.toLowerCase()} for perfection!` :
                    `Good tonal foundation! Polish your ${refineTone.toLowerCase()} for even better results!`
            };
        }

        function generatePronunciationTips(text) {
            const tips = [
                "üéØ Listen to native speakers and mimic their tone patterns",
                "üéµ Practice with music - Chinese songs help with tone memory",
                "ü™û Use a mirror to watch your mouth shape while speaking",
                "üì± Record yourself daily to track improvement",
                "üë• Find a language exchange partner for real conversation",
                "üìö Focus on one tone at a time until it becomes natural",
                "üéß Use tone drills and repetition exercises",
                "üó£Ô∏è Exaggerate tones at first, then gradually make them more natural"
            ];
            
            return tips.sort(() => 0.5 - Math.random()).slice(0, 3);
        }

        function generateNextSteps(score) {
            if (score >= 95) {
                return [
                    "Challenge yourself with complex idioms and poetry",
                    "Try teaching others - you're ready to be a pronunciation mentor!",
                    "Explore regional dialects and advanced speaking contexts"
                ];
            } else if (score >= 90) {
                return [
                    "Practice advanced conversational patterns",
                    "Try tongue twisters and rapid speech exercises",
                    "Work on emotional expression and storytelling"
                ];
            } else if (score >= 85) {
                return [
                    "Expand to longer sentences and paragraphs",
                    "Practice with native speakers for real conversations",
                    "Try more complex vocabulary and expressions"
                ];
            } else {
                return [
                    "Continue building on your strong foundation",
                    "Practice consistently to maintain your excellent progress",
                    "Challenge yourself with slightly more difficult content"
                ];
            }
        }

        function getEncouragingMessage(score) {
            if (score >= 95) return "ÔøΩ Exceptional! Native-level pronunciation! Â§™Ê£í‰∫Ü! (Amazing!)";
            if (score >= 90) return "ÔøΩ Outstanding work! Your pronunciation is excellent! ÂæàÂ•Ω! (Very good!)";
            if (score >= 85) return "üéâ Fantastic! You're really mastering this! ‰∫Ü‰∏çËµ∑! (Remarkable!)";
            if (score >= 80) return "ÔøΩ Great job! Your pronunciation skills are impressive! Âä†Ê≤π! (Keep going!)";
            return "üí™ Excellent effort! You're doing wonderfully! ÁªßÁª≠Âä™Âäõ! (Continue working hard!)";
        }

        function getFunEncouragementMessage(score) {
            const messages = [
                `üéâ Âìá! Scored ${score}%! You're becoming a Mandarin superstar! Â§™Ê£í‰∫Ü!`,
                `‚≠ê Amazing ${score}%! Your pronunciation is getting stronger every day! Âä†Ê≤π!`,
                `üöÄ Fantastic ${score}%! Ready to chat with native speakers! ÂæàÂ•Ω!`,
                `üèÜ Wonderful ${score}%! You're making your AI teacher proud! ‰∫Ü‰∏çËµ∑!`,
                `üí´ Excellent ${score}%! Keep this energy up! ÁªßÁª≠Âä™Âäõ!`,
                `üåü Brilliant ${score}%! Your confidence is showing! ‰Ω†ÂæàÊ£í!`
            ];
            return messages[Math.floor(Math.random() * messages.length)];
        }

        async function calculatePronunciationScore() {
            // Check if we actually have audio data
            if (!studentAudioBlob || !currentLesson || !currentLesson.audioData) {
                return { score: 0, features: null };
            }
            
            try {
                // Extract audio features from both recordings
                const masterFeatures = await extractAudioFeatures(currentLesson.audioData);
                const studentFeatures = await extractAudioFeatures(studentAudioBlob);
                
                // Compare audio features
                const comparison = compareAudioFeatures(masterFeatures, studentFeatures);
                
                return {
                    score: comparison.overallScore,
                    features: {
                        master: masterFeatures,
                        student: studentFeatures,
                        comparison: comparison
                    }
                };
            } catch (error) {
                console.error('Audio analysis error:', error);
                // Fallback to simulated scoring
                return { 
                    score: Math.round(45 + Math.random() * 50),
                    features: null 
                };
            }
        }

        // Extract audio features for pronunciation analysis
        async function extractAudioFeatures(audioData) {
            return new Promise((resolve, reject) => {
                try {
                    // Convert audio data to AudioBuffer for analysis
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // In a real implementation, you would:
                    // 1. Use Web Audio API to analyze frequency spectrum
                    // 2. Extract F0 (fundamental frequency) for tone analysis
                    // 3. Calculate formants for vowel recognition
                    // 4. Measure timing and rhythm patterns
                    // 5. Extract MFCC features for phoneme comparison
                    
                    // Simulated feature extraction for demo
                    const features = {
                        fundamentalFrequency: {
                            mean: 150 + Math.random() * 100, // Hz
                            variance: Math.random() * 50,
                            contour: generateF0Contour() // Tone pattern
                        },
                        formants: {
                            f1: 500 + Math.random() * 300, // First formant
                            f2: 1200 + Math.random() * 800, // Second formant
                            f3: 2500 + Math.random() * 500  // Third formant
                        },
                        spectralFeatures: {
                            centroid: Math.random() * 2000,
                            bandwidth: Math.random() * 1000,
                            rolloff: Math.random() * 3000
                        },
                        temporalFeatures: {
                            duration: 2 + Math.random() * 3, // seconds
                            speechRate: 3 + Math.random() * 2, // syllables/sec
                            pauseRatio: Math.random() * 0.3
                        },
                        mfccCoefficients: Array(13).fill().map(() => Math.random() * 2 - 1)
                    };
                    
                    resolve(features);
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Generate F0 contour for tone analysis (Mandarin has 4 main tones)
        function generateF0Contour() {
            const tonePatterns = {
                tone1: [0.8, 0.8, 0.8], // High level
                tone2: [0.4, 0.7, 0.9], // Rising
                tone3: [0.6, 0.3, 0.7], // Falling-rising
                tone4: [0.9, 0.5, 0.2]  // Falling
            };
            
            const randomTone = Object.keys(tonePatterns)[Math.floor(Math.random() * 4)];
            return {
                pattern: tonePatterns[randomTone],
                toneType: randomTone,
                confidence: Math.random()
            };
        }

        // Compare audio features between master and student recordings
        function compareAudioFeatures(masterFeatures, studentFeatures) {
            // Teacher audio is considered 98-100% perfect as the benchmark
            const teacherPerfectionRange = 98 + Math.random() * 2; // 98-100%
            
            // F0 comparison for tone accuracy (teacher = perfect reference)
            const f0Similarity = calculateF0Similarity(
                masterFeatures.fundamentalFrequency,
                studentFeatures.fundamentalFrequency
            );
            
            // Formant comparison for vowel accuracy
            const vowelAccuracy = calculateVowelAccuracy(
                masterFeatures.formants,
                studentFeatures.formants
            );
            
            // Temporal comparison for rhythm and timing
            const rhythmAccuracy = calculateRhythmAccuracy(
                masterFeatures.temporalFeatures,
                studentFeatures.temporalFeatures
            );
            
            // MFCC comparison for overall phonetic similarity
            const phoneticSimilarity = calculateMFCCSimilarity(
                masterFeatures.mfccCoefficients,
                studentFeatures.mfccCoefficients
            );
            
            // Calculate similarity to teacher's "perfect" pronunciation
            const similarityToTeacher = (
                f0Similarity * 0.35 +        // Tone is crucial in Mandarin
                vowelAccuracy * 0.25 +       // Vowel clarity
                rhythmAccuracy * 0.20 +      // Timing and rhythm
                phoneticSimilarity * 0.20    // Overall phonetic match
            ) / 100;
            
            // Scale student score relative to teacher's benchmark
            const overallScore = Math.round(similarityToTeacher * teacherPerfectionRange);
            
            return {
                overallScore,
                toneAccuracy: f0Similarity,
                vowelAccuracy,
                rhythmAccuracy,
                phoneticSimilarity,
                detailedAnalysis: {
                    f0Difference: Math.abs(masterFeatures.fundamentalFrequency.mean - studentFeatures.fundamentalFrequency.mean),
                    toneContourMatch: compareToneContours(masterFeatures.fundamentalFrequency.contour, studentFeatures.fundamentalFrequency.contour),
                    formantDistances: calculateFormantDistances(masterFeatures.formants, studentFeatures.formants),
                    timingDeviation: Math.abs(masterFeatures.temporalFeatures.duration - studentFeatures.temporalFeatures.duration)
                }
            };
        }

        // Helper functions for feature comparison
        function calculateF0Similarity(masterF0, studentF0) {
            const freqDiff = Math.abs(masterF0.mean - studentF0.mean);
            const maxDiff = 100; // Hz tolerance
            return Math.max(0, 100 - (freqDiff / maxDiff) * 100);
        }

        function calculateVowelAccuracy(masterFormants, studentFormants) {
            const f1Diff = Math.abs(masterFormants.f1 - studentFormants.f1);
            const f2Diff = Math.abs(masterFormants.f2 - studentFormants.f2);
            const avgDiff = (f1Diff + f2Diff) / 2;
            return Math.max(0, 100 - (avgDiff / 200) * 100);
        }

        function calculateRhythmAccuracy(masterTemporal, studentTemporal) {
            const durationDiff = Math.abs(masterTemporal.duration - studentTemporal.duration);
            const rateDiff = Math.abs(masterTemporal.speechRate - studentTemporal.speechRate);
            return Math.max(0, 100 - ((durationDiff + rateDiff) / 4) * 100);
        }

        function calculateMFCCSimilarity(masterMFCC, studentMFCC) {
            const euclideanDistance = Math.sqrt(
                masterMFCC.reduce((sum, val, i) => sum + Math.pow(val - studentMFCC[i], 2), 0)
            );
            return Math.max(0, 100 - euclideanDistance * 10);
        }

        function compareToneContours(masterContour, studentContour) {
            const patternMatch = masterContour.pattern.reduce((sum, val, i) => 
                sum + Math.abs(val - studentContour.pattern[i]), 0
            );
            return Math.max(0, 100 - patternMatch * 50);
        }

        function calculateFormantDistances(masterFormants, studentFormants) {
            return {
                f1Distance: Math.abs(masterFormants.f1 - studentFormants.f1),
                f2Distance: Math.abs(masterFormants.f2 - studentFormants.f2),
                f3Distance: Math.abs(masterFormants.f3 - studentFormants.f3)
            };
        }

        async function getClaudeAnalysis(analysisResult) {
            try {
                let prompt = `Analyze this Mandarin pronunciation practice session:

Lesson: ${currentLesson.title}
Text: ${currentLesson.text}
Type: ${currentLesson.type}
Student Score: ${analysisResult.score}/100`;

                // Include detailed audio analysis if available
                if (analysisResult.features && analysisResult.features.comparison) {
                    const comparison = analysisResult.features.comparison;
                    prompt += `

DETAILED AUDIO ANALYSIS:
- Tone Accuracy: ${Math.round(comparison.toneAccuracy)}%
- Vowel Accuracy: ${Math.round(comparison.vowelAccuracy)}%
- Rhythm Accuracy: ${Math.round(comparison.rhythmAccuracy)}%
- Phonetic Similarity: ${Math.round(comparison.phoneticSimilarity)}%

TECHNICAL MEASUREMENTS:
- F0 Difference: ${Math.round(comparison.detailedAnalysis.f0Difference)}Hz
- Tone Contour Match: ${Math.round(comparison.detailedAnalysis.toneContourMatch)}%
- Duration Deviation: ${comparison.detailedAnalysis.timingDeviation.toFixed(2)}s
- Formant Distances: F1=${Math.round(comparison.detailedAnalysis.formantDistances.f1Distance)}Hz, F2=${Math.round(comparison.detailedAnalysis.formantDistances.f2Distance)}Hz

Master Recording Features:
- Average F0: ${Math.round(analysisResult.features.master.fundamentalFrequency.mean)}Hz
- Tone Pattern: ${analysisResult.features.master.fundamentalFrequency.contour.toneType}
- Duration: ${analysisResult.features.master.temporalFeatures.duration.toFixed(2)}s

Student Recording Features:
- Average F0: ${Math.round(analysisResult.features.student.fundamentalFrequency.mean)}Hz
- Tone Pattern: ${analysisResult.features.student.fundamentalFrequency.contour.toneType}
- Duration: ${analysisResult.features.student.temporalFeatures.duration.toFixed(2)}s`;
                }

                prompt += `

Provide detailed, constructive feedback in the following format:
1. Overall Assessment (2-3 sentences)
2. Strengths (2-3 specific points)
3. Areas for Improvement (2-3 specific points with actionable advice)
4. Specific Pronunciation Tips for this ${currentLesson.type}
5. Practice Recommendations

Be encouraging and specific. Focus on common Mandarin pronunciation challenges.`;

                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1500,
                        messages: [
                            { role: "user", content: prompt }
                        ]
                    })
                });

                const data = await response.json();
                return data.content[0].text;
            } catch (error) {
                console.error('Error getting Claude analysis:', error);
                return getFallbackFeedback(analysisResult.score);
            }
        }

        function getFallbackFeedback(score) {
            if (score === 0) {
                return `‚ö†Ô∏è **Demo Mode Notice**: No audio analysis performed. This is a demonstration version with simulated scoring. In a production version, your pronunciation would be compared against the master recording using advanced audio processing and AI.`;
            } else if (score >= 85) {
                return `üéØ **Simulated Feedback**: Excellent work! Your pronunciation appears strong. (Note: This is demo feedback - real analysis would compare your audio with the master recording)`;
            } else if (score >= 70) {
                return `üìà **Simulated Feedback**: Good effort! You're making progress. Focus on tone accuracy and clarity. (Note: This is demo feedback - real analysis would provide specific pronunciation guidance)`;
            } else if (score >= 45) {
                return `üí™ **Simulated Feedback**: Keep practicing! Pay attention to the master recording and focus on matching the tones precisely. (Note: This is demo feedback - real analysis would identify specific areas for improvement)`;
            } else {
                return `üîÑ **Demo Mode**: This tool is in demonstration mode. Please ensure you have both master and student recordings for accurate analysis.`;
            }
        }

        function displayResults(score, feedback, audioFeatures) {
            // Use the new enhanced display function
            const analysis = {
                score: score,
                grade: getGradeFromScore(score),
                lessonText: currentLesson?.text || currentLesson?.title || "Practice text",
                complexity: 'intermediate',
                strengths: generateStrengths(score),
                improvements: generateImprovements(score),
                toneAnalysis: generateToneAnalysis(),
                pronunciationTips: generatePronunciationTips(currentLesson?.text || ""),
                nextSteps: generateNextSteps(score)
            };
            
            displayAdvancedResults(analysis);
        }

        // Display Fun AI Results with Animations
        function displayFunResults(analysis) {
            const resultsArea = document.getElementById('results-area');
            const scoreNumber = document.getElementById('score-number');
            const scoreFill = document.getElementById('score-fill');
            const aiFeedback = document.getElementById('ai-feedback');
            const detailedMetrics = document.getElementById('detailed-metrics');

            // Show results area with excitement
            resultsArea.style.display = 'block';
            resultsArea.scrollIntoView({ behavior: 'smooth' });

            // Animated score reveal
            let currentScore = 0;
            const targetScore = analysis.score;
            scoreNumber.textContent = '0';
            scoreFill.style.width = '0%';

            const scoreAnimation = setInterval(() => {
                currentScore += 2;
                if (currentScore >= targetScore) {
                    currentScore = targetScore;
                    clearInterval(scoreAnimation);
                    
                    // Celebration animation when score is revealed
                    scoreNumber.style.transform = 'scale(1.2)';
                    setTimeout(() => {
                        scoreNumber.style.transform = 'scale(1)';
                    }, 300);
                }
                scoreNumber.textContent = currentScore;
                scoreFill.style.width = currentScore + '%';
                
                // Color based on score
                if (currentScore >= 95) {
                    scoreFill.style.background = 'linear-gradient(45deg, #FFD700, #FFA500)';
                } else if (currentScore >= 85) {
                    scoreFill.style.background = 'linear-gradient(45deg, #32CD32, #228B22)';
                } else if (currentScore >= 75) {
                    scoreFill.style.background = 'linear-gradient(45deg, #4169E1, #0000CD)';
                } else {
                    scoreFill.style.background = 'linear-gradient(45deg, #FF6347, #DC143C)';
                }
            }, 30);

            // Fun AI feedback with personality
            setTimeout(() => {
                aiFeedback.innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 3em; margin-bottom: 10px;">${analysis.emoji}</div>
                        <h3 style="color: #2196F3; margin-bottom: 15px;">AI ËÄÅÂ∏à Says:</h3>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%); padding: 20px; border-radius: 15px; margin-bottom: 15px; border-left: 5px solid #4CAF50;">
                        <h4 style="color: #2e7d32; margin-bottom: 10px;">üéâ ${analysis.praise}</h4>
                        <p style="font-size: 1.1em; margin: 0;"><strong>Grade: ${analysis.grade}</strong></p>
                    </div>

                    <div style="background: #fff3e0; padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #ff9800;">
                        <h4 style="color: #f57c00; margin-bottom: 8px;">üí° Improvement Tip:</h4>
                        <p style="margin: 0;">${analysis.improvement}</p>
                    </div>

                    <div style="background: #f0f4ff; padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #3f51b5;">
                        <h4 style="color: #3949ab; margin-bottom: 8px;">üß† ${analysis.funFact}</h4>
                    </div>

                    <div style="background: #fce4ec; padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #e91e63;">
                        <h4 style="color: #c2185b; margin-bottom: 8px;">üöÄ ${analysis.nextChallenge}</h4>
                    </div>

                    <div style="text-align: center; background: linear-gradient(135deg, #ffecb3 0%, #ffe0b2 100%); padding: 15px; border-radius: 12px; border: 2px solid #ffc107;">
                        <h4 style="color: #e65100; margin-bottom: 8px;">üá®üá≥ ${analysis.chineseEncouragement}</h4>
                    </div>
                `;
            }, 1000);

            // Fun metrics display
            setTimeout(() => {
                detailedMetrics.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2em; margin-bottom: 5px;">üéØ</div>
                            <strong>Accuracy</strong><br>
                            ${analysis.score}%
                        </div>
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2em; margin-bottom: 5px;">‚≠ê</div>
                            <strong>Grade</strong><br>
                            ${analysis.grade}
                        </div>
                        <div style="background: #fff3e0; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2em; margin-bottom: 5px;">üî•</div>
                            <strong>Confidence</strong><br>
                            ${analysis.score >= 85 ? 'High' : analysis.score >= 75 ? 'Good' : 'Building'}
                        </div>
                        <div style="background: #f3e5f5; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2em; margin-bottom: 5px;">üéµ</div>
                            <strong>Tone Quality</strong><br>
                            ${analysis.score >= 85 ? 'Excellent' : analysis.score >= 75 ? 'Good' : 'Improving'}
                        </div>
                    </div>
                `;
            }, 1500);
        }

        // Display comprehensive AI results
        function displayAdvancedResults(analysis) {
            const resultsArea = document.getElementById('results-area');
            const scoreNumber = document.getElementById('score-number');
            const scoreFill = document.getElementById('score-fill');
            const aiFeedback = document.getElementById('ai-feedback');
            const detailedMetrics = document.getElementById('detailed-metrics');

            // Show results area
            resultsArea.style.display = 'block';

            // Update score display with grade
            scoreNumber.innerHTML = `
                <div style="font-size: 3em; color: ${analysis.grade.color};">${analysis.score}</div>
                <div style="font-size: 1.2em; margin: 10px 0; color: ${analysis.grade.color};">
                    ${analysis.grade.letter} - ${analysis.grade.label}
                </div>
            `;
            scoreFill.style.width = analysis.score + '%';
            scoreFill.style.background = analysis.grade.color;

            // Display comprehensive AI feedback
            aiFeedback.innerHTML = `
                <div class="ai-analysis-container">
                    <div class="analysis-section">
                        <h4 style="color: #4CAF50; margin: 0 0 10px 0;">üåü What You Did Well</h4>
                        <ul style="margin: 0; padding-left: 20px;">
                            ${analysis.strengths.map(strength => `<li style="margin: 5px 0;">${strength}</li>`).join('')}
                        </ul>
                    </div>

                    <div class="analysis-section" style="margin-top: 20px;">
                        <h4 style="color: #FF9800; margin: 0 0 10px 0;">üéØ Areas for Improvement</h4>
                        <ul style="margin: 0; padding-left: 20px;">
                            ${analysis.improvements.map(improvement => `<li style="margin: 5px 0;">${improvement}</li>`).join('')}
                        </ul>
                    </div>

                    <div class="analysis-section" style="margin-top: 20px;">
                        <h4 style="color: #2196F3; margin: 0 0 10px 0;">üéµ Tone Analysis</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3;">
                            <p><strong>Overall Tone Accuracy:</strong> ${analysis.toneAnalysis.overall}%</p>
                            <p><strong>Strongest:</strong> ${analysis.toneAnalysis.strongest}</p>
                            <p><strong>Needs Work:</strong> ${analysis.toneAnalysis.needsWork}</p>
                            <p style="color: #666; font-style: italic;">${analysis.toneAnalysis.tip}</p>
                        </div>
                    </div>

                    <div class="analysis-section" style="margin-top: 20px;">
                        <h4 style="color: #9C27B0; margin: 0 0 10px 0;">üí° Pronunciation Tips</h4>
                        <div style="display: grid; gap: 8px;">
                            ${analysis.pronunciationTips.map(tip => `
                                <div style="background: #f3e5f5; padding: 10px; border-radius: 6px; font-size: 0.9em;">
                                    ${tip}
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="analysis-section" style="margin-top: 20px;">
                        <h4 style="color: #FF5722; margin: 0 0 10px 0;">üöÄ Next Steps</h4>
                        <ol style="margin: 0; padding-left: 20px;">
                            ${analysis.nextSteps.map(step => `<li style="margin: 5px 0;">${step}</li>`).join('')}
                        </ol>
                    </div>
                </div>
            `;

            // Display enhanced detailed metrics
            detailedMetrics.innerHTML = `
                <div class="metrics-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="metric-card" style="background: #e8f5e8; padding: 15px; border-radius: 10px; text-align: center;">
                        <h5 style="margin: 0 0 10px 0; color: #2e7d32;">Tone Accuracy</h5>
                        <div style="font-size: 2em; font-weight: bold; color: #4CAF50;">${analysis.toneAnalysis.overall}%</div>
                    </div>
                    <div class="metric-card" style="background: #e3f2fd; padding: 15px; border-radius: 10px; text-align: center;">
                        <h5 style="margin: 0 0 10px 0; color: #1565c0;">Clarity Score</h5>
                        <div style="font-size: 2em; font-weight: bold; color: #2196F3;">${Math.round(Math.random() * 15 + 83)}%</div>
                    </div>
                    <div class="metric-card" style="background: #fff3e0; padding: 15px; border-radius: 10px; text-align: center;">
                        <h5 style="margin: 0 0 10px 0; color: #ef6c00;">Rhythm Match</h5>
                        <div style="font-size: 2em; font-weight: bold; color: #FF9800;">${Math.round(Math.random() * 16 + 82)}%</div>
                    </div>
                    <div class="metric-card" style="background: #f3e5f5; padding: 15px; border-radius: 10px; text-align: center;">
                        <h5 style="margin: 0 0 10px 0; color: #7b1fa2;">Confidence</h5>
                        <div style="font-size: 2em; font-weight: bold; color: #9C27B0;">${Math.round(Math.random() * 18 + 80)}%</div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; border: 2px dashed #dee2e6;">
                    <h5 style="margin: 0 0 10px 0; color: #495057;">üìä Lesson Complexity: ${analysis.complexity.toUpperCase()}</h5>
                    <p style="margin: 0; color: #6c757d;">
                        You practiced: "<strong>${analysis.lessonText}</strong>"<br>
                        <small>Keep practicing similar ${analysis.complexity} level content to build consistency!</small>
                    </p>
                </div>
            `;

            // Scroll to results
            resultsArea.scrollIntoView({ behavior: 'smooth' });
        }

        function generateDetailedMetrics(score, audioFeatures) {
            if (!audioFeatures || !audioFeatures.comparison) {
                // Fallback to simulated metrics
                const toneAccuracy = Math.max(50, score - Math.random() * 10);
                const clarity = Math.max(50, score + Math.random() * 10);
                const rhythm = Math.max(50, score - Math.random() * 5);

                return `
                    <div class="feedback-item">
                        <strong>Tone Accuracy:</strong> ${Math.round(toneAccuracy)}% <em>(simulated)</em>
                    </div>
                    <div class="feedback-item">
                        <strong>Clarity:</strong> ${Math.round(clarity)}% <em>(simulated)</em>
                    </div>
                    <div class="feedback-item">
                        <strong>Rhythm & Pacing:</strong> ${Math.round(rhythm)}% <em>(simulated)</em>
                    </div>
                `;
            }

            // Use actual audio analysis results
            const comparison = audioFeatures.comparison;
            const details = comparison.detailedAnalysis;

            return `
                <div class="feedback-item">
                    <strong>üéµ Tone Accuracy:</strong> ${Math.round(comparison.toneAccuracy)}%
                    <br><small>F0 difference: ${Math.round(details.f0Difference)}Hz | Contour match: ${Math.round(details.toneContourMatch)}%</small>
                </div>
                <div class="feedback-item">
                    <strong>üó£Ô∏è Vowel Clarity:</strong> ${Math.round(comparison.vowelAccuracy)}%
                    <br><small>Formant distances: F1=${Math.round(details.formantDistances.f1Distance)}Hz, F2=${Math.round(details.formantDistances.f2Distance)}Hz</small>
                </div>
                <div class="feedback-item">
                    <strong>‚è∞ Rhythm & Timing:</strong> ${Math.round(comparison.rhythmAccuracy)}%
                    <br><small>Duration deviation: ${details.timingDeviation.toFixed(2)}s</small>
                </div>
                <div class="feedback-item">
                    <strong>üîä Phonetic Similarity:</strong> ${Math.round(comparison.phoneticSimilarity)}%
                    <br><small>Overall acoustic pattern match</small>
                </div>
                <div class="feedback-item">
                    <strong>üìä Technical Analysis:</strong>
                    <br><small>Master F0: ${Math.round(audioFeatures.master.fundamentalFrequency.mean)}Hz (${audioFeatures.master.fundamentalFrequency.contour.toneType})</small>
                    <br><small>Student F0: ${Math.round(audioFeatures.student.fundamentalFrequency.mean)}Hz (${audioFeatures.student.fundamentalFrequency.contour.toneType})</small>
                </div>
            `;
        }

        function savePracticeSession(score) {
            const session = {
                lessonId: currentLesson.id,
                lessonTitle: currentLesson.title,
                score: score,
                timestamp: new Date().toISOString()
            };

            practiceHistory.push(session);
            localStorage.setItem('practiceHistory', JSON.stringify(practiceHistory));
            
            // Gamification: Award XP and check achievements
            let xpEarned = Math.max(5, Math.round(score / 10)); // 5-10 XP based on score
            let reason = '';
            
            if (score >= 98) {
                reason = 'ÂÆåÁæé! Perfect like a native! Â§™Ê£í‰∫Ü!';
                checkAchievements('perfect_score', score);
            } else if (score >= 90) {
                reason = 'ÂæàÂ•Ω! Excellent! You sound amazing! ÂéâÂÆ≥!';
                checkAchievements('high_scorer', score);
            } else if (score >= 80) {
                reason = '‰∏çÈîô! Great job! Getting better! Âä†Ê≤π!';
            } else if (score >= 70) {
                reason = 'Â•ΩÁöÑ! Good try! Keep going! ÁªßÁª≠Âä™Âäõ!';
            } else {
                reason = 'Ê≤°ÂÖ≥Á≥ª! No worries! Practice makes perfect! ÊÖ¢ÊÖ¢Êù•!';
            }
            
            // First practice achievement
            if (practiceHistory.length === 1) {
                checkAchievements('first_practice');
            }
            
            // Consistent practice achievement
            if (practiceHistory.length === 5) {
                checkAchievements('consistent');
            }
            
            // Tone mastery achievement (simulate based on score)
            if (score >= 85) {
                checkAchievements('tone_master', score);
            }
            
            awardXP(xpEarned, reason);
            
            // Show random student achievement notification
            setTimeout(() => {
                showRandomStudentAchievement();
            }, 2000);
            
            updateDashboard();
        }

        function showRandomStudentAchievement() {
            const randomStudentName = generateRandomStudentName();
            const achievements = [
                `Â∞±ËææÂà∞‰∫Ü Level 3! Tone master mode! üéµ`,
                `scored 95%! Â§™ÂéâÂÆ≥‰∫Ü! Basically fluent now! üåü`,
                `completed session #10! ÂæàÊ£í! On fire! üî•`,
                `unlocked "Â£∞Ë∞ÉÂ§ßÂ∏à"! Tone Master Áß∞Âè∑! üèÜ`,
                `hit 5-day streak! ÂùöÊåÅ‰∏çÊáà! Unstoppable! ‚ö°`,
                `leveled up! ÂçáÁ∫ß‰∫Ü! Getting so good! üöÄ`,
                `perfect tones! ÂÆåÁæé! Native speaker vibes! üéØ`,
                `mastered 25 words! ËØçÊ±áÂ§ßÁéã! Word wizard! üìö`
            ];
            
            const randomAchievement = achievements[Math.floor(Math.random() * achievements.length)];
            
            // Mix of other students and encouraging messages for current student
            const messages = [
                `üéâ ${randomStudentName} ${randomAchievement}`,
                `üí™ Âä†Ê≤π ${studentName}! You're crushing it! ÂæàÊ£í!`,
                `üåü Âìá ${studentName}! Better than 85% of students! ÂéâÂÆ≥!`,
                `üéØ Amazing work ${studentName}! ‰Ω†ÁöÑÂèëÈü≥ getting so good! Ê£íÊûÅ‰∫Ü!`,
                `ü§ñ Beep! ${studentName} improvement detected! ËøõÊ≠•ÂæàÂ§ß! ÂìàÂìà!`
            ];
            
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            showAIMessage(randomMessage);
        }

        function updateDashboard() {
            const totalAttempts = practiceHistory.length;
            const avgScore = totalAttempts > 0 
                ? Math.round(practiceHistory.reduce((sum, s) => sum + s.score, 0) / totalAttempts)
                : 0;
            const bestScore = totalAttempts > 0
                ? Math.max(...practiceHistory.map(s => s.score))
                : 0;

            document.getElementById('total-attempts').textContent = totalAttempts;
            document.getElementById('avg-score').textContent = avgScore;
            document.getElementById('best-score').textContent = bestScore;
            
            // Update gamification stats
            document.getElementById('current-level-dash').textContent = getCurrentLevel();
            document.getElementById('total-xp').textContent = playerStats.xp;
            document.getElementById('achievements-count').textContent = playerStats.achievements.length;

            // Display recent history
            const historyList = document.getElementById('history-list');
            const recentSessions = practiceHistory.slice(-5).reverse();

            if (recentSessions.length === 0) {
                historyList.innerHTML = '<p style="color: #999;">No practice sessions yet</p>';
                return;
            }

            historyList.innerHTML = recentSessions.map(session => `
                <div class="history-item">
                    <div>
                        <strong>${session.lessonTitle}</strong><br>
                        <small>${new Date(session.timestamp).toLocaleString()}</small>
                    </div>
                    <div class="history-score">${session.score}</div>
                </div>
            `).join('');
        }

        // Student Initialization (No Authentication Required)  
        async function initializeStudent(name) {
            try {
                // Create a simple student record for offline mode
                currentStudent = {
                    id: Date.now(), // Simple ID for local storage
                    name: name,
                    created_at: new Date().toISOString()
                };
                
                showAIMessage(`Â§™Ê£í‰∫Ü! Awesome! Welcome ${name}! Ready to learn Mandarin? üéâ`);
                await loadAllLessons();
                
            } catch (error) {
                console.error('Error initializing student:', error);
                showAIMessage(`Âá∫Èîô‰∫Ü! Oops! Something went wrong! Let's use offline mode! üòÖ`);
            }
        }

        async function loadAllLessons() {
            try {
                // Students use local lessons primarily
                showAIMessage(`ÂáÜÂ§áÂ•Ω‰∫Ü! Ready! Loading practice lessons! üìö‚ú®`);
                
                // Try to load from Supabase only if available (optional enhancement)
                if (typeof db !== 'undefined' && db.getAllPublicLessons) {
                    try {
                        const { data: onlineLessons, error } = await db.getAllPublicLessons();
                        if (onlineLessons && !error && onlineLessons.length > 0) {
                            // Merge online lessons with local ones
                            lessons = [...lessons, ...onlineLessons];
                            showAIMessage(`Â§™Â•Ω‰∫Ü! Great! Found ${onlineLessons.length} online lessons too! üåü`);
                        }
                    } catch (e) {
                        console.log('Online lessons not available, using local lessons');
                    }
                } else {
                    showAIMessage(`Á¶ªÁ∫øÊ®°Âºè! Offline mode! Using built-in lessons! üíæ`);
                }
                
                loadLessons(); // Refresh the lesson display with existing lessons
                
            } catch (error) {
                console.error('Error loading lessons:', error);
                showAIMessage(`ÁΩëÁªúÈóÆÈ¢ò! Network issue! Working offline! üõú‚ùå`);
            }
        }

        async function saveStudentProgress(lessonId, score, xpEarned) {
            if (!currentStudent) return;
            
            try {
                // Only save to Supabase if available
                if (typeof db !== 'undefined' && db.saveStudentProgress) {
                    const { data, error } = await db.saveStudentProgress(
                        currentStudent.name, 
                        lessonId, 
                        xpEarned, 
                        playerStats.achievements
                    );
                    
                    if (error) {
                        console.log('Online progress save failed - using local storage only');
                    } else {
                        console.log('Progress saved online!');
                    }
                } else {
                    console.log('Using local storage for progress tracking');
                }
                
            } catch (error) {
                console.log('Online save not available - progress stored locally');
            }
        }

        // Update the existing XP award function with optional Supabase saving
        const originalAwardXP = awardXP;
        awardXP = async function(amount, reason) {
            originalAwardXP(amount, reason);
            
            // Save progress if we have current lesson and student
            if (currentStudent && currentLesson) {
                const score = lastScore || 0; // Use last recorded score
                await saveStudentProgress(currentLesson.id, score, amount);
            }
        };

        // Fun bilingual AI messages for different situations
        const funMessages = {
            classNotFound: [
                "ÂìéÂëÄ! Oops! That class code is like a unicorn - doesn't exist! ü¶Ñ",
                "ÈîôËØØ! Error! Class code went on vacation! üèñÔ∏è",
                "Êâæ‰∏çÂà∞! Not found! Did your teacher give you the right code? ü§î"
            ],
            welcomeToClass: [
                "Â§™Ê£í‰∫Ü! Awesome! You're now in the coolest Mandarin class! üòé",
                "Ê¨¢Ëøé! Welcome! Time to become a Mandarin superstar! ‚≠ê",
                "ÂæàÂ•Ω! Great! Let's make your tongue do Chinese gymnastics! ü§∏‚Äç‚ôÇÔ∏è"
            ],
            noLessons: [
                "Á©∫ÁöÑ! Empty! Your teacher is probably brewing some amazing lessons! ‚òï",
                "ËøòÊ≤°Êúâ! Not yet! Like waiting for popcorn to pop! üçø",
                "Âø´‰∫Ü! Soon! Your lessons are in the oven baking! üç™"
            ]
        };

        function getRandomFunMessage(category) {
            const messages = funMessages[category] || [];
            return messages[Math.floor(Math.random() * messages.length)] || "Something happened! üòÖ";
        }

        // Initialize student from localStorage on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (studentName) {
                // Automatically initialize if we have saved data
                setTimeout(() => {
                    initializeStudent(studentName);
                }, 1000);
            }
        });
    </script>
</body>
</html>
